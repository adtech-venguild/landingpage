<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VENGUILD ‚Äì Profile Resolver</title>
<style>
  :root{ --bg:#0c1116; --card:#0f141a; --text:#e9ecf1; --muted:#9fb0c3; --line:rgba(255,255,255,.08); --accent:#37e07d; --gold:#ffdf9e;}
  *{box-sizing:border-box} body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
  .wrap{max-width:1100px; margin:28px auto; padding:0 16px}
  h1{margin:0 0 6px; font-size:28px; font-family:Cinzel,serif; color:var(--gold)}
  p{margin:6px 0 18px; color:var(--muted)}
  .grid{display:grid; grid-template-columns: 1fr 1fr; gap:18px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px}
  .images{display:flex; align-items:center; justify-content:center; gap:18px}
  .images .stack{position:relative; width:420px; height:420px; display:grid; place-items:center; background:#0b1015; border:1px dashed #243145; border-radius:12px}
  .images img{max-width:92%; max-height:92%; object-fit:contain; position:absolute; inset:0; margin:auto; filter:drop-shadow(0 8px 16px rgba(0,0,0,.4))}
  .images img.shadow{left:-75px; z-index:1; opacity:.92}
  .images img.prof{right:-60px; z-index:2}
  .kv{display:grid; gap:6px}
  .kv div{display:flex; gap:8px; align-items:baseline}
  .k{min-width:195px; color:#b9c8da; font-size:13px; text-transform:uppercase; letter-spacing:.06em}
  .v code{background:#0b1015; border:1px solid #253246; padding:2px 6px; border-radius:6px}
  pre{margin:0; white-space:pre-wrap; word-break:break-word; background:#0b1015; border:1px solid #243145; padding:10px; border-radius:10px; color:#9ad6bf}
  .cta{margin-top:16px; display:flex; gap:10px; flex-wrap:wrap}
  .btn{display:inline-block; background:linear-gradient(135deg, var(--accent), #1aa37c); color:#0b1015; font-weight:800; text-decoration:none; padding:12px 18px; border-radius:12px}
  .btn.ghost{background:transparent; border:1px dashed #355; color:#9fd}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} .images .stack{width:100%; height:360px} }

  /* tiny orb preview (kept small & translucent) */
  .orbs{display:flex; gap:8px; margin-top:8px}
  .orb{--c:#fff; width:22px; height:22px; border-radius:50%;
        background: radial-gradient(circle at 32% 28%, transparent 0 38%, rgba(0,0,0,.55) 100%),
                    radial-gradient(circle at 70% 70%, color-mix(in srgb, var(--c) 70%, transparent), transparent 60%);
        border:1px solid color-mix(in srgb, var(--c) 60%, transparent 40%);
        box-shadow:0 0 10px color-mix(in srgb, var(--c) 60%, transparent),
                   0 0 26px color-mix(in srgb, var(--c) 40%, transparent);
        opacity:.9}
</style>
</head>
<body>
<div class="wrap">
  <h1>Profile Resolver</h1>
  <p>This resolves your saved profile, computes Elemental Affinity, Level, Title & Rank, and prepares a compact JSON for the personality test.</p>

  <div class="grid">
    <!-- Left: images -->
    <div class="card">
      <h3 style="margin:0 0 8px">Preview</h3>
      <div class="images">
        <div class="stack">
          <img id="imgShadow" class="shadow" alt="Shadow" onerror="this.style.opacity=.25">
          <img id="imgProf" class="prof" alt="Professional" onerror="this.style.opacity=.25">
        </div>
      </div>
    </div>

    <!-- Right: resolved data -->
    <div class="card">
      <h3 style="margin:0 0 8px">Resolved Values</h3>
      <div class="kv">
        <div><div class="k">Adventurer</div><div class="v"><code id="outName">‚Äî</code></div></div>
        <div><div class="k">Elemental Affinity</div><div class="v"><code id="outElemNames">‚Äî</code></div></div>
        <div class="orbs" id="orbs"></div>
        <div><div class="k">Element Codes (unique)</div><div class="v"><code id="outElemCode">‚Äî</code></div></div>
        <div><div class="k">Recommended Title</div><div class="v"><code id="outTitle">‚Äî</code></div></div>
        <div><div class="k">Recommended Rank</div><div class="v"><code id="outRank">‚Äî</code></div></div>
        <div><div class="k">Total Level</div><div class="v"><code id="outTotal">‚Äî</code></div></div>
        <div><div class="k">Experience Level Total</div><div class="v"><code id="outExpTotal">‚Äî</code></div></div>
        <div><div class="k">Education Level Total</div><div class="v"><code id="outEduTotal">‚Äî</code></div></div>
        <div><div class="k">Gender Code</div><div class="v"><code id="outGenderCode">‚Äî</code></div></div>
        <div><div class="k">Region Code</div><div class="v"><code id="outRegion">‚Äî</code></div></div>
        <div><div class="k">Shadow Path</div><div class="v"><code id="outShadow">‚Äî</code></div></div>
        <div><div class="k">Professional Path</div><div class="v"><code id="outProf">‚Äî</code></div></div>
      </div>

      <h4 style="margin:14px 0 6px">Element Description</h4>
      <pre id="outDesc">‚Äî</pre>

      <h4 style="margin:14px 0 6px">Level Breakdown</h4>
      <pre id="outLevelBreakdown">‚Äî</pre>

      <div class="cta">
        <a id="saveJson" class="btn ghost" href="#">üíæ Save profile JSON</a>
        <a href="personalitytest.html" class="btn">Take the personality test ‚Üí</a>
        <a href="information.html" class="btn ghost">‚Üê Edit profile</a>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:18px">
    <h3 style="margin:0 0 8px">Raw Saved Payload</h3>
    <pre id="dump">‚Äî</pre>
  </div>
</div>

<script>
/* ---------- config / paths ---------- */
const PATHS = {
  countries: 'data/country_ethnicity.json',   // country -> region code (e.g., "sea")
  programs : 'data/programs.json',            // Program/title -> ElementCode
  elements : 'data/elements.json',            // Combination/Description + Code like "1","12","134"
  sectors  : 'data/sectors.json'              // Code -> ElementCode (experience ‚Üí element)
};
const ELEM_NAME = {1:'Earth',2:'Fire',3:'Air',4:'Water',5:'Aether'};
const ORB_COLOR = { // Earth = dark brown, Aether = green
  '1':'#5b3a1e','2':'#ff6a6a','3':'#4da3ff','4':'#7ef2b0','5':'#37e07d'
};

/* ---------- tiny utils ---------- */
const $ = s => document.querySelector(s);
async function safeJSON(path){ try{ const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json(); }catch{return [];}}
function genderCode(g){ return (g && g.toLowerCase()==='m') ? '_m' : '_f'; }
function regionCodeFor(country, countries){
  const row = (countries||[]).find(x=>{
    const n = (x.Country||x.name||x.country||'').trim();
    return n.toLowerCase() === String(country||'').trim().toLowerCase();
  });
  let code = row?.region || row?.Region || row?.code || row?.Code || '';
  code = String(code||'').trim();
  if (!code) return '';
  if (!code.startsWith('_')) code = '_'+code;
  return code.toLowerCase();
}
function pickTopExperience(exps){
  if (!Array.isArray(exps) || !exps.length) return null;
  return [...exps].sort((a,b)=>{
    const A = Number(a.computedLevel || 0), B = Number(b.computedLevel || 0);
    if (B !== A) return B - A;
    const Ay = Number(a.years || 0), By = Number(b.years || 0);
    return (By - Ay);
  })[0];
}
function uniqueSortedDigits(arr){
  const s = Array.from(new Set(arr.filter(Boolean).map(Number)));
  s.sort((a,b)=>a-b);
  return s.join('');
}
function namesFromCodes(codeStr){ return codeStr.split('').map(d=>ELEM_NAME[+d]).filter(Boolean); }
function findElementDesc(codeStr, list){
  if (!codeStr) return null;
  const want = codeStr.split('').sort().join('');
  for (const row of (list||[])){
    const code = String(row.Code||row.code||'').split('').sort().join('');
    if (code===want) return {description: row.Description||row.description||'', combo: row.Combination||row.combination||''};
  }
  return null;
}

/* ---------- Title & Rank logic (same rules you‚Äôve been using) ---------- */
function levelTitle(total){
  if(total>=100) return 'Master';
  if(total>=76)  return 'Advanced II';
  if(total>=51)  return 'Advanced I';
  if(total>=26)  return 'Apprentice';
  return 'Aspirant';
}
function baseRankFor(level){
  return level==='Master'      ? 'B' :
         level==='Advanced II' ? 'C' :
         level==='Advanced I'  ? 'D' :
         level==='Apprentice'  ? 'E' : 'F';
}
function countVerifications(){
  try{
    const v = JSON.parse(localStorage.getItem('venguild_verifications')||'{}')||{};
    return ['twoIDs','employment','diploma','tor','address','payslip','billing','ecommerce']
      .reduce((n,k)=>n+(v[k]?1:0),0);
  }catch{ return 0; }
}
function finalRankFor(level){
  const L = ['F','E','D','C','B','A','S'];
  const base = baseRankFor(level);
  const bI = L.indexOf(base);
  const steps = Math.min(countVerifications(), L.length-1-bI);
  return L[bI+steps];
}

/* ---------- main ---------- */
(async function main(){
  // Read raw payload
  const saved = localStorage.getItem('venguild_complete_profile');
  $('#dump').textContent = saved || 'No profile found. Please complete your profile first.';
  if (!saved){
    // show quick fallback CTA
    $('.cta')?.insertAdjacentHTML('afterbegin','<a href="information.html" class="btn">Complete your profile ‚Üí</a>');
    return;
  }
  const payload = JSON.parse(saved);

  // Load reference data
  const [countries, programs, elements, sectors] = await Promise.all([
    safeJSON(PATHS.countries),
    safeJSON(PATHS.programs),
    safeJSON(PATHS.elements),
    safeJSON(PATHS.sectors)
  ]);

  // Mappings
  const sectorCodeToElem = new Map((sectors||[]).map(s => [
    String(s.Code||s.code||'').trim(),
    Number(s.ElementCode||s.elementCode||0)
  ]));

  // Resolve gender/region/paths
  const gCode = genderCode(payload.gender);
  const rCode = regionCodeFor(payload.citizenship, countries);
  const shadowPath = `assets/default/shadow${gCode}.png`;

  const top = pickTopExperience(payload.experience);
  const profCode = top?.code || '';
  const profPath = (profCode && gCode && rCode) ? `assets/professional/${profCode}${gCode}${rCode}.png` : '';

  // Elemental affinity: union of ALL exp elements + education elements
  const expElemCodes = (payload.experience||[]).map(x => sectorCodeToElem.get(String(x.code||'').trim()) || 0);
  const eduElems = [];
  for (const e of (payload.education||[])) {
    const programName = (e.program||'').trim().toLowerCase();
    const row = programs.find(p => String(p.Program||p.title||'').trim().toLowerCase() === programName);
    const ec = Number(row?.ElementCode || row?.elementCode || 0);
    if (ec) eduElems.push(ec);
  }
  const allElemCodes = uniqueSortedDigits([...expElemCodes, ...eduElems]); // e.g., "35"
  const elemNames = namesFromCodes(allElemCodes);
  const descHit = findElementDesc(allElemCodes, elements);
  const description = descHit?.description || '‚Äî';
  const comboLabel = descHit?.combo || (elemNames.length ? elemNames.join(' + ') : '‚Äî');

  // Totals
  let expTotal=0, eduTotal=0;
  const expLines=[], eduLines=[];
  (payload.experience || []).forEach(x=>{
    const years=+x.years||0, mult=+x.multiplier||0;
    const comp = +x.computedLevel || (years*mult);
    expTotal += comp;
    const label = x.industry || x.sector || x.code || '‚Äî';
    expLines.push(`${label}: ${years}y √ó ${mult} = ${comp}`);
  });
  (payload.education || []).forEach(e=>{
    const mult=+e.multiplier||0; eduTotal += mult;
    const label = `${e.program||'‚Äî'} (${e.level||'‚Äî'})`;
    eduLines.push(`${label} ‚Üí ${mult}`);
  });
  const totalLevel = expTotal + eduTotal;

  // Title & Rank
  const title = levelTitle(totalLevel);
  const rank  = finalRankFor(title);

  // Adventurer name
  const nameFull = [
    payload?.name?.first || '',
    payload?.name?.middle ? payload.name.middle + '.' : '',
    payload?.name?.last || ''
  ].filter(Boolean).join(' ').trim();

  // Paint UI
  $('#outName').textContent      = nameFull || '‚Äî';
  $('#outElemNames').textContent = comboLabel || '‚Äî';
  $('#outElemCode').textContent  = allElemCodes || '‚Äî';
  $('#outTitle').textContent     = title;
  $('#outRank').textContent      = rank;
  $('#outTotal').textContent     = String(totalLevel);
  $('#outExpTotal').textContent  = String(expTotal);
  $('#outEduTotal').textContent  = String(eduTotal);
  $('#outGenderCode').textContent= gCode || '‚Äî';
  $('#outRegion').textContent    = rCode || '‚Äî';
  $('#outShadow').textContent    = shadowPath || '‚Äî';
  $('#outProf').textContent      = profPath || '‚Äî';
  $('#outDesc').textContent      = `${comboLabel}\n\n${description}`;

  const breakdownText = ['Experience:',...expLines,'','Education:',...eduLines].join('\n');
  $('#outLevelBreakdown').textContent = breakdownText;

  if (shadowPath) $('#imgShadow').src = shadowPath;
  if (profPath)   $('#imgProf').src   = profPath;

  // Tiny orb preview (kept close/small with transparency)
  const orbs = $('#orbs');
  orbs.innerHTML = '';
  allElemCodes.split('').forEach(d=>{
    if (!ORB_COLOR[d]) return;
    const o = document.createElement('span');
    o.className='orb';
    o.style.setProperty('--c', ORB_COLOR[d]);
    orbs.appendChild(o);
  });

  // Build compact profile JSON for personality test
  const profileSummary = {
    name: {
      first: payload?.name?.first || '',
      middle: payload?.name?.middle || null,
      last: payload?.name?.last || '',
      full: nameFull
    },
    elementalAffinity: {
      codes: allElemCodes,           // "35"
      names: elemNames,              // ["Air","Aether"]
      label: comboLabel,             // "Air + Aether"
      description
    },
    totals: {
      experience: expTotal,
      education : eduTotal,
      total     : totalLevel
    },
    recommendation: { title, rank },
    assets: {
      shadow: shadowPath || null,
      professional: profPath || null,
      regionCode: rCode || '',
      genderCode: gCode || ''
    },
    raw: { sectorTopCode: top?.code || null },
    savedAt: new Date().toISOString()
  };

  // Persist for personalitytest.html
  localStorage.setItem('venguild_profile', JSON.stringify(profileSummary));

  // Downloadable venguild_profile.json
  (function makeDownload(json){
    const a = document.getElementById('saveJson');
    if(!a) return;
    const blob = new Blob([JSON.stringify(json, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = 'venguild_profile.json';
  })(profileSummary);
})();
</script>
</body>
</html>
