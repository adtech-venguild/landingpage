<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VENGUILD ‚Äì Complete Profile</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* Allow the overlay itself to scroll if content is tall */
.overlay{ overflow:auto; }
.overlay.show{ align-items:flex-start; }
.panel{ margin:32px auto; max-height:calc(100vh - 64px); overflow:auto; }
body.modal-open{ overflow:hidden; }
.overlay, .panel{ -webkit-overflow-scrolling:touch; }

:root{ --bg:#0c1116; --card:#0f141a; --muted:#a9b4c1; --text:#e9ecf1; --gold:#ffdf9e; --accent:#37e07d; --line:rgba(255,255,255,.08); }
*{box-sizing:border-box}
html,body{height:100%; margin:0}
body{
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: var(--bg); color: var(--text);
  min-height: 100dvh; display:grid; place-items:center;
  background-image: linear-gradient(to bottom, rgba(6,12,18,.55), rgba(6,12,18,.6)), url("assets/background/background1.png");
  background-size:cover; background-position:center;
}
.card{
  width:min(780px,94vw); background:var(--card); border:1px solid var(--line);
  border-radius:16px; padding:28px; text-align:center;
  box-shadow: 0 10px 30px rgba(0,0,0,.45); animation: fadeIn .8s ease;
}
@keyframes fadeIn{from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:translateY(0)}}
.logo{width:116px; display:block; margin:0 auto 6px; filter: drop-shadow(0 0 8px rgba(255,255,255,.6)) drop-shadow(0 0 14px rgba(0,0,0,.7));}
h1{font-family:Cinzel,serif; font-weight:900; margin:6px 0 8px; font-size: clamp(30px, 5vw, 46px); color:var(--gold); text-shadow:0 3px 8px rgba(0,0,0,.6);}
p.lead{color:#d1dae4; margin:8px 0 0; font-size:17px}
.actions{margin-top:20px; display:flex; justify-content:center; gap:12px}
.btn{
  padding:14px 22px; border-radius:14px; font-weight:800; cursor:pointer; font-size:17px;
  background:linear-gradient(135deg, var(--accent), #2cd18c, #1aa37c);
  color:#0c1116; text-decoration:none; border:none; position:relative; overflow:hidden;
  box-shadow:0 6px 18px rgba(0,0,0,.5), inset 0 0 8px rgba(255,255,255,.25);
  transition:transform .2s ease, box-shadow .2s ease;
}
.btn:hover{transform:translateY(-2px) scale(1.02); box-shadow:0 10px 24px rgba(0,0,0,.6), inset 0 0 12px rgba(255,255,255,.3)}
.btn.ghost{background:transparent; border:1px dashed #355; color:#9fd; box-shadow:none}
.btn.danger{background:linear-gradient(135deg, #ffb4b4, #ff9898); color:#4a0b0b}
.overlay{position: fixed; inset:0; display:none; place-items:center; padding:24px; background: rgba(4,8,12,.55); backdrop-filter: blur(6px);}
.overlay.show{display:grid; animation:fadeIn .2s ease}
.panel{
  width:min(980px,96vw); background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow: 0 20px 60px rgba(0,0,0,.55);
  display:grid; grid-template-columns: 1fr; gap:22px; padding:22px;
}
.panel h2{font-family:Cinzel,serif; margin:0 0 12px; font-size: clamp(20px, 3.2vw, 28px); color:var(--gold);}
form{display:grid; gap:16px}
.row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
.row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
.row4{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:12px}
label span{display:block; font-size:12px; letter-spacing:.08em; color:var(--muted); margin-bottom:6px; text-transform:uppercase}
input[type="text"], input[type="date"], input[type="number"], select{
  width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line); background:#0b1015; color:var(--text);
  outline:none; transition:border .15s ease, box-shadow .15s ease; font-size:15px;
}
input:focus, select:focus{border-color:#3dd39b; box-shadow:0 0 0 3px rgba(61,211,155,.18)}
fieldset{border:1px solid var(--line); border-radius:14px; padding:14px; margin:0; background:#0b1015;}
legend{padding:0 8px; color:#94a3b8; font-size:12px; letter-spacing:.08em; text-transform:uppercase}
.stack{display:grid; gap:10px}
.inline{display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap}
.footer{display:flex; justify-content:flex-end; gap:10px; margin-top:6px;}
.btn.secondary{background:linear-gradient(135deg, #c6d3e0, #b9c7d6, #a6b6c7); color:#0c1116;}
.result{margin-top:8px; background:#0b1015; border:1px solid #223046; border-radius:12px; padding:12px; text-align:left}
.result pre{margin:0; white-space:pre-wrap; word-break:break-word; color:#9ad6bf; font-size:13px}
@media (max-width:720px){ .row, .row3, .row4{grid-template-columns:1fr} }

/* --- Tiny Date Picker (UNCHANGED) --- */
.dp {
  position: absolute; z-index: 9999;
  background:#0b1015; color:#e9ecf1; border:1px solid #223046;
  border-radius:12px; width: 292px; box-shadow:0 12px 30px rgba(0,0,0,.55);
  padding:10px; user-select:none;
}
.dp header{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
.dp header .btn { background:#101722; border:1px solid #223046; color:#cfe6ff; border-radius:10px; padding:6px 10px; font-weight:700; cursor:pointer; }
.dp header .label { font-weight:800; letter-spacing:.03em; cursor:pointer }
.dp .grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
.dp .cell { text-align:center; padding:8px 0; border-radius:8px; cursor:pointer; background:#0d141f; border:1px solid #1b2738; font-weight:600; }
.dp .cell.muted { opacity:.45; }
.dp .cell.disabled { opacity:.35; cursor:not-allowed; }
.dp .cell:hover:not(.disabled){ background:#152234; }
.dp .cell.active { background:linear-gradient(135deg,#37e07d,#1aa37c); color:#0c1116; border-color:transparent; }
.dp .years { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
.dp .year { text-align:center; padding:10px 0; border-radius:10px; cursor:pointer; background:#0d141f; border:1px solid #1b2738; font-weight:700; }
.dp .year.disabled { opacity:.35; cursor:not-allowed; }
.dp .year:hover:not(.disabled){ background:#152234; }
.dp .year.active { background:linear-gradient(135deg,#37e07d,#1aa37c); color:#0c1116; border-color:transparent; }

/* --- Filter-Select combobox (for ALL dropdowns except DOB) --- */
.fs{ position:relative; }
.fs select{ display:none; } /* keep in DOM, driven by JS */
.fs-input{
  width:100%; padding:12px 38px 12px 12px; border-radius:12px;
  border:1px solid var(--line); background:#0b1015; color:#e9ecf1; font-size:15px;
  outline:none; transition:border .15s ease, box-shadow .15s ease;
}
.fs-input:focus{ border-color:#3dd39b; box-shadow:0 0 0 3px rgba(61,211,155,.18); }
.fs-caret{
  position:absolute; right:10px; top:50%; transform:translateY(-50%); pointer-events:none; opacity:.7; font-size:14px;
}
.fs-menu{
  position:absolute; left:0; right:0; top:calc(100% + 6px);
  max-height:240px; overflow:auto; padding:6px; z-index:10000;
  background:#0b1015; border:1px solid #223046; border-radius:12px; display:none;
  box-shadow:0 12px 30px rgba(0,0,0,.55);
}
.fs.open .fs-menu{ display:block; }
.fs-item{
  display:block; width:100%; text-align:left; cursor:pointer; user-select:none;
  background:#0d141f; border:1px solid #1b2738; color:#e9ecf1;
  border-radius:8px; padding:8px 10px; margin:4px 0; font-weight:600;
}
.fs-item:hover{ background:#152234; }
.fs-item.active{
  background:linear-gradient(135deg,#37e07d,#1aa37c); color:#0c1116; border-color:transparent;
}
</style>
</head>
<body>
  <div class="card">
    <img src="assets/logo.png" alt="VENGUILD logo" class="logo" />
    <h1>Welcome, Adventurer!</h1>
    <p class="lead">Complete your profile to reveal your adventurer type, level, and class.</p>
    <div class="actions">
      <button class="btn" id="openOverlay" type="button">‚öîÔ∏è Complete Your Profile ‚Üí</button>
    </div>
  </div>

  <!-- OVERLAY -->
  <div class="overlay" id="overlay">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="panelTitle">
      <div>
        <h2 id="panelTitle">Complete Profile</h2>
        <form id="profileForm">
          <!-- Name -->
          <div class="row3">
            <label>
              <span>Last Name</span>
              <input type="text" id="lastName" required placeholder="e.g., Flores">
            </label>
            <label>
              <span>First Name</span>
              <input type="text" id="firstName" required placeholder="e.g., Jose Marie">
            </label>
            <label>
              <span>Middle Initial (optional)</span>
              <input type="text" id="middleInitial" maxlength="1" placeholder="M">
            </label>
          </div>

          <!-- Citizenship / Gender -->
          <div class="row">
            <label>
              <span>Citizenship / Nationality</span>
              <select id="citizenship" required>
                <option value="" disabled selected>Select citizenship‚Ä¶</option>
              </select>
            </label>
            <label>
              <span>Gender</span>
              <select id="gender" required>
                <option value="m">Male</option>
                <option value="f">Female</option>
                <option value="nb">Non-Binary</option>
                <option value="na">Prefer not to say</option>
              </select>
            </label>
          </div>

          <!-- DOB / Current Address (DOB logic retained) -->
          <div class="row">
            <label>
              <span>Date of Birth</span>
              <input type="text" id="dob" required placeholder="mm/dd/yyyy" autocomplete="bday" readonly>
            </label>
            <label>
              <span>Current Address</span>
              <input type="text" id="address" placeholder="Street, City, Region" autocomplete="street-address">
            </label>
          </div>

          <!-- Education (repeatable) -->
          <fieldset>
            <legend>Education</legend>
            <div id="educationList" class="stack"></div>
            <button type="button" class="btn ghost" id="addEducation">+ Add Education</button>
          </fieldset>

          <!-- Work Experience (repeatable) -->
          <fieldset>
            <legend>Work Experience</legend>
            <div id="experienceList" class="stack"></div>
            <button type="button" class="btn ghost" id="addExperience">+ Add Work Experience</button>
          </fieldset>

          <!-- Training / Certification / Workshops (repeatable) -->
          <fieldset>
            <legend>Training / Certification / Workshops</legend>
            <div id="trainingList" class="stack"></div>
            <button type="button" class="btn ghost" id="addTraining">+ Add Training / Certification</button>
          </fieldset>

          <div class="footer">
            <button type="button" class="btn secondary" id="closeOverlay">Cancel</button>
            <button type="submit" class="btn">Save ‚Üí</button>
          </div>

          <!-- Show results here -->
          <div id="result" class="result" style="display:none;">
            <pre id="resultPre"></pre>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
/* ---------- data paths ---------- */
const PATHS = {
  countries: 'data/country_ethnicity.json',
  programs: 'data/programs.json',
  eduLevels: 'data/education_levels.json',
  sectors: 'data/sectors.json',
  careerLevels: 'data/career_levels.json',
  universities: 'data/universities.json',
  trainings: 'data/trainings.json',
  institutions: 'data/institutions.json'
};

/* ---------- tiny helpers ---------- */
const $ = (s, r=document) => r.querySelector(s);
function el(tag, attrs={}, ...children){
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k === 'class') n.className = v;
    else if (k === 'dataset') Object.assign(n.dataset, v);
    else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
    else if (v !== null && v !== undefined) n.setAttribute(k, v);
  }
  for (const c of children) n.appendChild(typeof c==='string' ? document.createTextNode(c) : c);
  return n;
}
async function safeJSON(path){
  try{
    const res = await fetch(path, {cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }catch(e){
    console.warn('Missing/bad JSON:', path, e.message);
    return [];
  }
}

/* ---------- in-memory data ---------- */
const DATA = {
  countries:[], programs:[], eduLevels:[], sectors:[], careerLevels:[],
  universities:[], trainings:[], institutions:[]
};

/* ---------- FilterSelect (substring match) ---------- */
const FilterSelect = (() => {
  const norm = s => (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
  function enhance(sel){
    if (!sel || sel.dataset.fs === '1') return sel;
    sel.dataset.fs = '1';

    const wrap = document.createElement('div'); wrap.className = 'fs';
    const input = document.createElement('input'); input.className='fs-input'; input.type='text';
    const caret = document.createElement('div'); caret.className='fs-caret'; caret.textContent='‚ñæ';
    const menu  = document.createElement('div'); menu.className='fs-menu';
    const ph = sel.options?.[0]?.text || 'Select...';
    input.placeholder = ph;

    sel.parentNode.insertBefore(wrap, sel);
    wrap.appendChild(sel);
    wrap.appendChild(input);
    wrap.appendChild(caret);
    wrap.appendChild(menu);

    const items = [];
    for (const opt of sel.options){
      if (opt.disabled) continue;
      const li = document.createElement('button');
      li.type='button'; li.className='fs-item'; li.textContent = opt.text;
      li.dataset.value = opt.value;
      li.addEventListener('click', () => {
        sel.value = opt.value;
        input.value = opt.text;
        close();
        sel.dispatchEvent(new Event('change',{bubbles:true}));
      });
      items.push({opt, li, key: norm(opt.text)});
    }

    function open(){
      if (wrap.classList.contains('open')) return;
      wrap.classList.add('open');
      filter(input.value);
    }
    function close(){ wrap.classList.remove('open'); }
    function filter(q){
      const nq = norm(q);
      menu.innerHTML='';
      let shown = 0;
      for (const it of items){
        const hit = nq === '' ? true : it.key.includes(nq);
        if (hit){
          menu.appendChild(it.li);
          shown++;
        }
        if (shown >= 300) break;
      }
      if (shown === 0){
        const none = document.createElement('div');
        none.className='fs-item'; none.style.opacity='.55'; none.textContent='No matches';
        none.tabIndex=-1; menu.appendChild(none);
      }
    }

    const current = sel.options[sel.selectedIndex];
    if (current && current.value) input.value = current.text;

    input.addEventListener('focus', open);
    input.addEventListener('input', () => { open(); filter(input.value); });
    input.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowDown'){ open(); const first = menu.querySelector('.fs-item'); first?.focus(); e.preventDefault(); }
      if (e.key === 'Escape'){ close(); e.stopPropagation(); }
    });
    menu.addEventListener('keydown', (e)=>{
      const arr = [...menu.querySelectorAll('.fs-item')];
      const i = arr.indexOf(document.activeElement);
      if (e.key === 'ArrowDown'){ (arr[i+1]||arr[0])?.focus(); e.preventDefault(); }
      if (e.key === 'ArrowUp'){ (arr[i-1]||arr[arr.length-1])?.focus(); e.preventDefault(); }
      if (e.key === 'Escape'){ input.focus(); close(); e.preventDefault(); }
    });
    document.addEventListener('mousedown', (e)=>{ if (!wrap.contains(e.target)) close(); });

    sel._fs = {wrap,input,menu,open,close,filter};
    return sel;
  }
  return { enhance };
})();

/* ---------- builders ---------- */
function buildCitizenshipOptions(){
  const sel = $('#citizenship');
  const names = [];
  for (const item of DATA.countries){
    const name = item.Country || item.name || item.country || '';
    if (name) names.push(name);
  }
  names.sort().forEach(name => sel.appendChild(el('option', {value:name}, name)));
  FilterSelect.enhance(sel);
}

function buildProgramSelect(){
  const sel = el('select', { required: true });
  sel.appendChild(el('option', {value:'', disabled:'', selected:''}, 'Select program‚Ä¶'));
  DATA.programs.map(p => p.Program || p.title).filter(Boolean).sort()
    .forEach(t => sel.appendChild(el('option', {value:t}, t)));
  return sel;
}

function buildEduLevelSelect(){
  const sel = el('select', { required: true });
  sel.appendChild(el('option', {value:'', disabled:'', selected:''}, 'Select level‚Ä¶'));
  DATA.eduLevels.forEach(l => sel.appendChild(el('option', {value:l.title, dataset:{mult:l.multiplier}}, l.title)));
  return sel;
}

function buildUniversitySelect(){
  const sel = el('select', { required: true });
  sel.appendChild(el('option', {value:'', disabled:'', selected:''}, 'University / Institution‚Ä¶'));
  const list = (DATA.universities||[])
    .map(u => u.name || u.University || u.institution || u.title)
    .filter(Boolean).sort();
  list.forEach(name => sel.appendChild(el('option', {value:name}, name)));
  return sel;
}

function buildSectorSelect(){
  const sel = el('select', { required: true });
  sel.appendChild(el('option', {value:'', disabled:'', selected:''}, 'Select industry‚Ä¶'));

  const src = DATA.sectors || [];
  if (!src.length) {
    sel.appendChild(el('option', {value:'(unavailable)', disabled:''}, '‚Äî No industries loaded ‚Äî'));
    return sel;
  }

  const items = src.map(row => ({
    industry: (row.Industry || '').trim(),
    sector:   (row.Sector   || '').trim(),
    code:      String(row.Code || '').trim(),
    industryCode: String(row.IndustryCode || '').trim(),
    sectorCode:   String(row.SectorCode   || '').trim(),
    element:   (row.Element || '').trim(),
    elementCode: String(row.ElementCode ?? '')
  })).filter(i => i.sector && i.code)
    .sort((a,b)=> (a.industry.localeCompare(b.industry) || a.sector.localeCompare(b.sector)));

  for (const i of items){
    sel.appendChild(
      el('option', {
        value: i.sector,
        dataset: {
          code: i.code,
          industryCode: i.industryCode,
          sectorCode: i.sectorCode,
          element: i.element,
          elementCode: i.elementCode
        }
      }, i.sector)
    );
  }
  return sel;
}

function buildCareerLevelSelect(){
  const sel = el('select', { required: true });
  sel.appendChild(el('option', {value:'', disabled:'', selected:''}, 'Select job title / level‚Ä¶'));
  const src = DATA.careerLevels;
  if (Array.isArray(src) && src.length){
    src.forEach(l => sel.appendChild(el('option', {value:l.title, dataset:{mult:l.multiplier}}, l.title)));
  } else {
    sel.appendChild(el('option', {value:'(unavailable)', disabled:''}, '‚Äî No levels loaded ‚Äî'));
  }
  return sel;
}

/* Month / Year builders for work experience */
function buildMonthSelect(def=''){
  const sel = el('select', { required:true });
  sel.appendChild(el('option', {value:'', disabled:'', selected:''}, 'Month‚Ä¶'));
  const months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
  months.forEach(m => sel.appendChild(el('option', {value:m}, m)));
  if (def) sel.value = def;
  return sel;
}
function buildYearSelect(def=''){
  const sel = el('select', { required:true });
  sel.appendChild(el('option', {value:'', disabled:'', selected:''}, 'Year‚Ä¶'));
  const nowY = new Date().getFullYear();
  for (let y=nowY; y>=1960; y--) sel.appendChild(el('option', {value:String(y)}, String(y)));
  if (def) sel.value = def;
  return sel;
}

/* Training builders */
function buildTrainingTitleSelect(){
  const sel = el('select', { required:true });
  sel.appendChild(el('option', {value:'', disabled:'', selected:''}, 'Select training / certification‚Ä¶'));
  const list = (DATA.trainings||[]).map(t => t.title || t.name).filter(Boolean).sort();
  list.forEach(t => sel.appendChild(el('option', {value:t}, t)));
  return sel;
}
function buildInstitutionSelect(){
  const sel = el('select', { required:true });
  sel.appendChild(el('option', {value:'', disabled:'', selected:''}, 'Organizer / Institution‚Ä¶'));
  const list = (DATA.institutions||[]).map(i => i.name || i.title).filter(Boolean).sort();
  list.forEach(n => sel.appendChild(el('option', {value:n}, n)));
  return sel;
}

/* ---------- repeatable rows ---------- */
function educationRow(initial={}){
  const row = el('div', {class:'row3'});
  const programSel = buildProgramSelect();
  const levelSel   = buildEduLevelSelect();
  const uniSel     = buildUniversitySelect();

  if (initial.program) programSel.value = initial.program;
  if (initial.level)   levelSel.value   = initial.level;
  if (initial.university) uniSel.value  = initial.university;

  const removeBtn = el('button', {type:'button', class:'btn danger remove-education'}, 'Remove');

  row.append(
    el('label', {}, el('span', {}, 'Program'), programSel),
    el('label', {}, el('span', {}, 'Education Level'), levelSel),
    el('label', {}, el('span', {}, 'University / Institution'), uniSel),
    el('div', {class:'inline'}, removeBtn)
  );

  [programSel, levelSel, uniSel].forEach(FilterSelect.enhance);
  return row;
}

function experienceRow(initial={}){
  const wrap = el('div', {class:'stack'});

  const top = el('div', {class:'row'});
  const sectorSel = buildSectorSelect();
  const levelSel  = buildCareerLevelSelect();
  top.append(
    el('label', {}, el('span', {}, 'Industry (Work Experience)'), sectorSel),
    el('label', {}, el('span', {}, 'Job Title / Level'), levelSel)
  );

  const dates = el('div', {class:'row4'});
  const sm = buildMonthSelect(initial.startMonth||'');
  const sy = buildYearSelect(initial.startYear||'');
  const em = buildMonthSelect(initial.endMonth||'');
  const ey = buildYearSelect(initial.endYear||'');
  const currentChk = el('input', {type:'checkbox', id:`cur_${Math.random().toString(36).slice(2)}`, checked: !!initial.current});
  function toggleEnd(disabled){
    em.disabled = ey.disabled = disabled;
    if (disabled){ em.value=''; ey.value=''; }
  }
  toggleEnd(!!initial.current);
  currentChk.addEventListener('change', ()=> toggleEnd(currentChk.checked));

  dates.append(
    el('label', {}, el('span', {}, 'Start Month'), sm),
    el('label', {}, el('span', {}, 'Start Year'), sy),
    el('label', {}, el('span', {}, 'End Month'), em),
    el('label', {}, el('span', {}, 'End Year'), ey),
  );

  const currentRow = el('div', {class:'row'});
  currentRow.append(
    el('label', {}, el('span', {}, 'Currently working here'), currentChk),
    el('div', {}) // spacer
  );

  const remove = el('div', {class:'inline'},
    el('button', {type:'button', class:'btn danger remove-experience'}, 'Remove')
  );

  wrap.append(top, dates, currentRow, remove);

  [sectorSel, levelSel, sm, sy, em, ey].forEach(FilterSelect.enhance);
  return wrap;
}

function trainingRow(initial={}){
  const wrap = el('div', {class:'stack'});

  const row1 = el('div', {class:'row'});
  const titleSel = buildTrainingTitleSelect();
  const orgSel   = buildInstitutionSelect();
  row1.append(
    el('label', {}, el('span', {}, 'Certification / Training Title'), titleSel),
    el('label', {}, el('span', {}, 'Organizer / Training Institution'), orgSel)
  );

  const row2 = el('div', {class:'row'});
  const durNum = el('input', {type:'number', min:'0', step:'1', placeholder:'e.g., 3', value: initial.durationValue ?? '', required:''});
  const durUnit = el('select', {required:''});
  ['day(s)','week(s)','month(s)'].forEach(u => durUnit.appendChild(el('option',{value:u}, u)));
  if (initial.durationUnit) durUnit.value = initial.durationUnit;
  row2.append(
    el('label', {}, el('span', {}, 'Duration'), durNum),
    el('label', {}, el('span', {}, 'Unit'), durUnit)
  );

  const remove = el('div', {class:'inline'},
    el('button', {type:'button', class:'btn danger remove-training'}, 'Remove')
  );

  wrap.append(row1, row2, remove);

  [titleSel, orgSel, durUnit].forEach(FilterSelect.enhance);
  return wrap;
}

/* ---------- helpers for experience years ---------- */
function yearsFrom(startMonth, startYear, endMonth, endYear, current){
  const now = new Date();
  const sY = parseInt(startYear||'0',10), sM = parseInt(startMonth||'0',10);
  if (!sY || !sM) return 0;
  let eY = parseInt(endYear||'0',10), eM = parseInt(endMonth||'0',10);
  if (current || !eY || !eM){ eY = now.getFullYear(); eM = now.getMonth()+1; }
  const months = Math.max(0, (eY - sY) * 12 + (eM - sM));
  return +(months / 12).toFixed(2);
}

/* ---------- boot ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  const overlay = $('#overlay');
  $('#openOverlay').addEventListener('click', ()=>{ overlay.classList.add('show'); document.body.classList.add('modal-open'); setTimeout(()=>$('#lastName').focus(), 50); });
  $('#closeOverlay').addEventListener('click', ()=>{ overlay.classList.remove('show'); document.body.classList.remove('modal-open'); });

  // NOTE: Removed "click outside closes modal" behavior per request.

  // Load JSON (gracefully)
  const [countries, programs, eduLevels, sectors, careerLevels, universities, trainings, institutions] = await Promise.all([
    safeJSON(PATHS.countries),
    safeJSON(PATHS.programs),
    safeJSON(PATHS.eduLevels),
    safeJSON(PATHS.sectors),
    safeJSON(PATHS.careerLevels),
    safeJSON(PATHS.universities),
    safeJSON(PATHS.trainings),
    safeJSON(PATHS.institutions)
  ]);
  Object.assign(DATA, {countries, programs, eduLevels, sectors, careerLevels, universities, trainings, institutions});

  // Static dropdowns
  buildCitizenshipOptions();
  FilterSelect.enhance($('#gender')); // searchable gender too

  // ‚ú® NO default rows (so optional sections don't block submit)

  // Add buttons
  $('#addEducation').addEventListener('click', (e)=>{ e.preventDefault(); $('#educationList').appendChild(educationRow()); });
  $('#addExperience').addEventListener('click', (e)=>{ e.preventDefault(); $('#experienceList').appendChild(experienceRow()); });
  $('#addTraining').addEventListener('click', (e)=>{ e.preventDefault(); $('#trainingList').appendChild(trainingRow()); });

  // Remove via delegation
  document.addEventListener('click', (e)=>{
    if (e.target.classList.contains('remove-education')) {
      e.preventDefault(); e.target.closest('.row3, .row')?.remove();
    }
    if (e.target.classList.contains('remove-experience')) {
      e.preventDefault(); e.target.closest('.stack')?.remove();
    }
    if (e.target.classList.contains('remove-training')) {
      e.preventDefault(); e.target.closest('.stack')?.remove();
    }
  });

  /* ----- DOB picker (unchanged logic, bound to #dob) ----- */
  const DOB_MIN = new Date(1900, 0, 1);
  function maxDobDate() {
    const t = new Date();
    return new Date(t.getFullYear()-16, t.getMonth(), t.getDate()); // 16 years ago
  }
  const pad = n => (n<10?'0':'')+n;
  const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const toDisplay = d => `${pad(d.getMonth()+1)}/${pad(d.getDate())}/${d.getFullYear()}`;
  (function initDobPicker(){
    const input = document.getElementById('dob');
    if (!input) return;
    let shown = false, view = 'day';
    let cur = new Date(2000, 0, 1);
    const maxDOB = maxDobDate();
    const val = (input.value || '').trim();
    if (val && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
      const [Y,M,D] = val.split('-').map(Number);
      cur = new Date(Y, M-1, D);
    } else {
      cur = new Date(maxDOB);
    }
    const pop = document.createElement('div');
    pop.className = 'dp'; pop.style.display = 'none'; document.body.appendChild(pop);
    function place(){ const r=input.getBoundingClientRect(); pop.style.top=`${window.scrollY + r.bottom + 6}px`; pop.style.left=`${window.scrollX + r.left}px`; }
    function clamp(d){ if (d < DOB_MIN) return new Date(DOB_MIN); if (d > maxDOB) return new Date(maxDOB); return d; }
    function renderHeader(c){
      const h=document.createElement('header');
      const prev=Object.assign(document.createElement('button'),{className:'btn',textContent:'‚óÄ'}); prev.onclick=()=>{ if(view==='day')cur.setMonth(cur.getMonth()-1); else cur.setFullYear(cur.getFullYear()-9); render(); };
      const label=Object.assign(document.createElement('div'),{className:'label'}); label.textContent=(view==='day')?cur.toLocaleString(undefined,{month:'long',year:'numeric'}):`${cur.getFullYear()-4} ‚Äì ${cur.getFullYear()+4}`; label.onclick=()=>{view=(view==='day'?'year':'day'); render();};
      const next=Object.assign(document.createElement('button'),{className:'btn',textContent:'‚ñ∂'}); next.onclick=()=>{ if(view==='day')cur.setMonth(cur.getMonth()+1); else cur.setFullYear(cur.getFullYear()+9); render(); };
      h.append(prev,label,next); c.appendChild(h);
    }
    function renderDays(container){
      const grid=document.createElement('div'); grid.className='grid';
      for (const s of ['Su','Mo','Tu','We','Th','Fr','Sa']){ const head=document.createElement('div'); head.className='cell muted'; head.style.fontWeight='800'; head.textContent=s; grid.appendChild(head); }
      const y=cur.getFullYear(), m=cur.getMonth(), first=new Date(y,m,1), startIdx=first.getDay(), daysInMonth=new Date(y,m+1,0).getDate();
      const prevDays = new Date(y, m, 0).getDate();
      for (let i=startIdx-1; i>=0; i--){ const d=document.createElement('div'); d.className='cell muted disabled'; d.textContent=String(prevDays - i); grid.appendChild(d); }
      for (let day=1; day<=daysInMonth; day++){
        const dEl=document.createElement('div'); dEl.className='cell'; dEl.textContent=String(day);
        const dateObj=new Date(y,m,day);
        const disabled=(dateObj<DOB_MIN) || (dateObj>maxDOB);
        if (disabled) dEl.classList.add('disabled');
        const valISO=(input.value||'').trim();
        if (valISO){ const [Y,M,D]=valISO.split('-').map(Number); if (Y===y && (M-1)===m && D===day) dEl.classList.add('active'); }
        if (!disabled){ dEl.onclick=()=>{ const picked=clamp(new Date(y,m,day)); input.value=toISO(picked); input.placeholder=toDisplay(picked); hide(); }; }
        grid.appendChild(dEl);
      }
      const totalCells = grid.children.length;
      const needed = (7*6) - totalCells;
      for (let i=1;i<=needed;i++){ const d=document.createElement('div'); d.className='cell muted disabled'; d.textContent=String(i); grid.appendChild(d); }
      container.appendChild(grid);
    }
    function renderYears(container){
      const wrap=document.createElement('div'); wrap.className='years';
      const start=cur.getFullYear()-4;
      for (let i=0;i<9;i++){
        const y=start+i; const btn=document.createElement('div'); btn.className='year'; btn.textContent=y;
        const earliest=new Date(y,0,1), latest=new Date(y,11,31);
        const disabled=(latest<DOB_MIN) || (earliest>maxDOB);
        if (disabled) btn.classList.add('disabled');
        if (y===cur.getFullYear()) btn.classList.add('active');
        if (!disabled) btn.onclick=()=>{ cur.setFullYear(y); view='day'; render(); };
        wrap.appendChild(btn);
      }
      container.appendChild(wrap);
    }
    function render(){ pop.innerHTML=''; renderHeader(pop); if(view==='day') renderDays(pop); else renderYears(pop); }
    function show(){ if(shown) return; shown=true; view='day'; place(); render(); pop.style.display='block'; window.addEventListener('resize',place); window.addEventListener('scroll',place,true); document.addEventListener('mousedown', outsideClose, true); }
    function hide(){ shown=false; pop.style.display='none'; window.removeEventListener('resize',place); window.removeEventListener('scroll',place,true); document.removeEventListener('mousedown', outsideClose, true); }
    function outsideClose(e){ if (e.target===input || pop.contains(e.target)) return; hide(); }
    input.addEventListener('click', show);
    input.addEventListener('keydown', (e)=>{ if ((e.key==='Enter'||e.key===' ') && !shown){ e.preventDefault(); show(); } if (e.key==='Escape' && shown){ e.preventDefault(); hide(); } });
    input.placeholder = toDisplay(maxDOB);
  })();

  // Submit ‚Üí redirect to preloaded.html
  document.getElementById('profileForm').addEventListener('submit', (e) => {
    e.preventDefault();

    const payload = {
      name: {
        last: document.getElementById('lastName').value.trim(),
        first: document.getElementById('firstName').value.trim(),
        middle: (document.getElementById('middleInitial').value.trim() || null)
      },
      gender: document.getElementById('gender').value,
      dob: document.getElementById('dob').value,
      address: document.getElementById('address').value.trim() || null,
      citizenship: document.getElementById('citizenship').value,
      education: [],
      experience: [],
      trainings: []
    };

    // collect education
    for (const group of document.querySelectorAll('#educationList .row3')) {
      const selects = group.querySelectorAll('select');
      const program = selects[0]?.value || '';
      const levelEl = selects[1];
      const level   = levelEl?.value || '';
      const mult    = parseFloat(levelEl?.selectedOptions?.[0]?.dataset?.mult || '0');
      const univ    = selects[2]?.value || '';
      if (program && level && univ) {
        payload.education.push({ program, level, university: univ, multiplier: mult });
      }
    }

    // collect experience
    for (const block of document.querySelectorAll('#experienceList .stack')) {
      const selects = block.querySelectorAll('select');
      const sectorSel = selects[0];
      const levelSel  = selects[1];
      const sm = selects[2]?.value || '';
      const sy = selects[3]?.value || '';
      const em = selects[4]?.value || '';
      const ey = selects[5]?.value || '';
      const current = block.querySelector('input[type="checkbox"]')?.checked || false;

      const industry  = sectorSel?.value || '';
      const code      = sectorSel?.selectedOptions?.[0]?.dataset?.code || '';
      const careerLevel = levelSel?.value || '';
      const mult      = parseFloat(levelSel?.selectedOptions?.[0]?.dataset?.mult || '0');
      const years     = yearsFrom(sm, sy, em, ey, current);

      if (industry && careerLevel && sm && sy && (current || (em && ey))) {
        payload.experience.push({
          industry, code, careerLevel,
          startMonth: sm, startYear: sy,
          endMonth: current?null:em, endYear: current?null:ey,
          current,
          years, multiplier: mult, computedLevel: +(years * mult).toFixed(2)
        });
      }
    }

    // collect trainings
    for (const block of document.querySelectorAll('#trainingList .stack')) {
      const selects = block.querySelectorAll('select');
      const title = selects[0]?.value || '';
      const org   = selects[1]?.value || '';
      const dur   = parseInt(block.querySelector('input[type="number"]')?.value || '0', 10);
      const unit  = selects[2]?.value || '';
      if (title && org && !Number.isNaN(dur) && unit) {
        payload.trainings.push({ title, organizer: org, durationValue: dur, durationUnit: unit });
      }
    }

    // Save to localStorage
    localStorage.setItem('venguild_complete_profile', JSON.stringify(payload));

    // Optional debug:
    // $('#result').style.display='block'; $('#resultPre').textContent = JSON.stringify(payload, null, 2);

    // üöÄ Redirect
    window.location.href = "preloaded.html";
  });
});
</script>
</body>
</html>
