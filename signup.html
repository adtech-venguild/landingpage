<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VENGUILD – Early Sign-Up</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{ --bg:#0c1116; --muted:#a9b4c1; --text:#e9ecf1; --gold:#ffdf9e; --accent:#37e07d; }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0}
  body{
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    color:var(--text); background:var(--bg);
    min-height:100dvh; display:grid; place-items:center;
    background-image:
      radial-gradient(1000px 600px at 50% -10%, rgba(21,42,66,.28), transparent 55%),
      url("assets/background/background1.png");
    background-size:cover; background-position:center;
  }

  /* Shell (no box) */
  .shell{ width:min(940px,94vw); padding:18px 16px; position:relative }

  /* Dimmed “curtain” when we speak */
  .curtain{
    position:fixed; inset:0; pointer-events:none; opacity:0;
    background: radial-gradient(1400px 800px at 50% 0%, rgba(8,14,20,.65), rgba(8,14,20,.35) 45%, rgba(8,14,20,0) 70%);
    transition:opacity .35s ease;
  }
  .curtain.show{opacity:1}

  .logo{width:118px; display:block; margin:0 auto 10px;
    filter: drop-shadow(0 0 8px rgba(255,255,255,.6)) drop-shadow(0 0 14px rgba(0,0,0,.7));}

  /* HERO STACK: fixed height, two layers (title then CTA) in the SAME spot */
  .heroStack{ position:relative; height:170px; margin:6px auto 8px; width:100%; }
  .heroLayer{
    position:absolute; inset:0; display:grid; place-items:center; opacity:0; transform:translateY(8px);
    transition:opacity .6s ease, transform .6s ease;
  }
  .heroLayer.show{ opacity:1; transform:none }
  .heroTitle{
    font-family:Cinzel,serif; font-weight:900; margin:0;
    font-size:clamp(34px,6.6vw,64px); color:var(--gold); text-align:center; letter-spacing:.02em;
    text-shadow:0 3px 8px rgba(0,0,0,.6);
  }

  /* Progress */
  .progress{display:flex; justify-content:center; gap:8px; margin:8px 0 14px}
  .dot{width:9px; height:9px; border-radius:50%; background:#223046; border:1px solid #2e4058}
  .dot.active{background:#37e07d; box-shadow:0 0 0 3px rgba(61,211,155,.18)}

  /* Narration area (stable height so fields never jump around) */
  .narration{min-height:130px; display:grid; place-items:center; gap:6px}
  h1.narr{font-family:Cinzel,serif; font-weight:900; margin:0; font-size:clamp(28px,5.2vw,48px); color:var(--gold); text-align:center; opacity:0; transform:translateY(6px)}
  h1.narr.show{animation:ti .9s ease forwards}
  p.lead{color:#d1dae4; margin:0; font-size:clamp(15px,1.7vw,18px); text-align:center; opacity:0}
  p.lead.show{animation:li .6s ease .9s forwards}
  @keyframes ti{to{opacity:1; transform:none}} @keyframes li{to{opacity:1}}

  /* Professional mockups row (top1 m/f then top2 m/f) */
  .proStage{display:none; justify-content:center; gap:12px; flex-wrap:wrap; margin:4px 0}
  .proStage.show{display:flex}
  .proStage img{width:148px; height:148px; object-fit:contain; filter:drop-shadow(0 6px 18px rgba(0,0,0,.45))}
  @media (max-width:720px){ .proStage img{width:120px; height:120px} }

  /* Fields */
  .field{display:grid; gap:10px; margin:14px 0}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:720px){ .row{grid-template-columns:1fr} }
  label span{display:block; font-size:12px; letter-spacing:.08em; color:var(--muted); text-transform:uppercase}
  input[type="text"]{
    width:100%; padding:14px; border-radius:14px; border:1px solid rgba(255,255,255,.08);
    background:#0b1015; color:#e9ecf1; outline:none; font-size:17px;
    transition:border .15s ease, box-shadow .15s ease;
  }
  input:focus{border-color:#3dd39b; box-shadow:0 0 0 3px rgba(61,211,155,.18)}
  .is-error{border-color:#ff6b6b!important; box-shadow:0 0 0 3px rgba(255,107,107,.18)!important}

  /* Chips + borderless combo */
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin:0 0 8px}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:7px 11px; border-radius:999px; background:#0d141f; border:1px solid #1b2738; font-weight:700; font-size:13px}
  .chip button{all:unset; cursor:pointer; padding:0 2px; line-height:1}
  .combo{position:relative}
  .combo .menu{
    position:absolute; left:0; right:0; top:calc(100% + 6px); max-height:300px; overflow:auto; padding:6px; z-index:1000;
    background:rgba(11,16,23,.98); border:0; border-radius:12px; display:none; box-shadow:0 18px 40px rgba(0,0,0,.6)
  }
  .combo.open .menu{display:block}
  .combo .item{display:block; width:100%; text-align:left; cursor:pointer; user-select:none; background:#0d141f; border:1px solid #1b2738; color:#e9ecf1; border-radius:8px; padding:9px 11px; margin:4px 0; font-weight:600}
  .combo .item:hover{background:#152234}
  .hint{color:#a9b4c1; font-size:13px} .limit{font-size:12px; color:#9ad6bf}
  .warn{display:none; margin:6px 0 0; padding:10px 12px; border:1px solid rgba(255,156,110,.5); color:#fff3ec; background:rgba(255,156,110,.1); border-radius:12px; font-weight:700}
  .warn.show{display:block}

  /* Actions */
  .actions{display:flex; justify-content:space-between; gap:12px; margin-top:12px}
  .btn{
    padding:14px 20px; border-radius:14px; font-weight:800; cursor:pointer; font-size:16px;
    background:linear-gradient(135deg, var(--accent), #2cd18c, #1aa37c);
    color:#0c1116; text-decoration:none; border:none;
    box-shadow:0 6px 18px rgba(0,0,0,.5), inset 0 0 8px rgba(255,255,255,.25);
    transition:transform .2s ease; white-space:nowrap
  }
  .btn:hover{transform:translateY(-2px) scale(1.02)}
  .btn.ghost{background:transparent; border:1px dashed #355; color:#9fd; box-shadow:none}

  /* Steps */
  .steps{display:grid; gap:14px; margin-top:8px}
  .step{display:none; animation:stepIn .28s ease}
  .step.show{display:block}
  @keyframes stepIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}

  /* Summary */
  .summary{display:grid; gap:12px; border:1px dashed #2e4058; border-radius:12px; padding:12px; background:#0b1015; margin-top:6px}
  .summary h3{margin:0 0 6px; font-family:Cinzel,serif; color:var(--gold); font-size:22px}
  .summary .row{display:grid; grid-template-columns:140px 1fr; gap:10px}
  .proRow{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .proRow img{width:120px; height:120px; object-fit:contain; filter:drop-shadow(0 6px 18px rgba(0,0,0,.45))}

  /* Fullscreen saving */
  .saving{position:fixed; inset:0; display:none; place-items:center; background:rgba(7,13,18,.72); backdrop-filter:blur(6px); z-index:9999; color:#e9ecf1; font-weight:800}
  .saving.show{display:grid; animation:fade .2s ease}
  .spinner{width:26px; height:26px; border-radius:50%; border:3px solid rgba(255,255,255,.18); border-top-color:#37e07d; animation:spin .9s linear infinite; margin-right:10px}
  .savingInner{display:flex; align-items:center; gap:10px}
  @keyframes spin{to{transform:rotate(360deg)}} @keyframes fade{from{opacity:0} to{opacity:1}}
</style>
</head>
<body>

<div class="curtain" id="curtain"></div>

<main class="shell" id="app">
  <img src="assets/logo.png" alt="VENGUILD logo" class="logo" />

  <!-- PROFESSIONAL MOCKUPS (top1 m/f then top2 m/f) -->
  <div id="proStage" class="proStage" aria-hidden="true"></div>

  <!-- HERO STACK (no box). Title fades out, button fades in at same spot -->
  <section id="s0" class="heroStack">
    <div id="s0Line" class="heroLayer">
      <h2 class="heroTitle">Great you're in!</h2>
    </div>
    <div id="s0CTA" class="heroLayer">
      <button class="btn" id="goS1" type="button">Let’s begin →</button>
    </div>
  </section>

  <!-- Progress -->
  <div class="progress" aria-hidden="true">
    <div class="dot" data-step="0"></div><div class="dot" data-step="1"></div>
    <div class="dot" data-step="2"></div><div class="dot" data-step="3"></div>
    <div class="dot" data-step="4"></div><div class="dot" data-step="5"></div>
  </div>

  <!-- Narration (stable space; text only fades in) -->
  <div class="narration">
    <h1 id="title" class="narr"></h1>
    <p id="subtitle" class="lead"></p>
  </div>

  <div class="steps">
    <!-- S1: Name -->
    <section class="step" id="s1">
      <div class="field">
        <div class="row" id="nameRow" style="display:none">
          <label><span>First Name</span><input type="text" id="firstName" placeholder="e.g., Jose Marie" autocomplete="given-name"></label>
          <label><span>Last Name</span><input type="text" id="lastName" placeholder="e.g., Flores" autocomplete="family-name"></label>
        </div>
        <div id="displayWrap" style="display:none">
          <label><span>Display Name</span><input type="text" id="displayName" placeholder="e.g., JM Flores"></label>
          <div class="hint">Some emails aren’t real names—set how you want to be addressed.</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" data-back type="button">Back</button>
        <div style="flex:1"></div>
        <button class="btn" id="toS2" type="button">Next →</button>
      </div>
      <div class="warn" id="nameWarn">Please enter at least a First or Display name.</div>
      <div class="warn" id="nameTaken" style="display:none;">That display name is already taken. Try another.</div>
    </section>

    <!-- S2: Industries -->
    <section class="step" id="s2">
      <div class="field">
        <div class="chips" id="industriesChips"></div>
        <div class="combo" id="industriesCombo">
          <input type="text" id="industriesInput" placeholder="Search industries…" autocomplete="off">
          <div class="menu" id="industriesMenu"></div>
        </div>
        <div class="hint"><span class="limit" id="industriesLimit">0 / 5 selected</span></div>
      </div>
      <div class="actions">
        <button class="btn ghost" data-back type="button">Back</button>
        <div style="flex:1"></div>
        <button class="btn" id="toS3" type="button">Next →</button>
      </div>
      <div class="warn" id="industriesWarn">Pick at least one industry.</div>
    </section>

    <!-- S3: Skills -->
    <section class="step" id="s3">
      <div class="field">
        <div class="chips" id="skillsChips"></div>
        <div class="combo" id="skillsCombo">
          <input type="text" id="skillsInput" placeholder="Search skills…" autocomplete="off">
          <div class="menu" id="skillsMenu"></div>
        </div>
        <div class="hint"><span class="limit" id="skillsLimit">0 / 7 selected</span></div>
      </div>
      <div class="actions">
        <button class="btn ghost" data-back type="button">Back</button>
        <div style="flex:1"></div>
        <button class="btn" id="toS4" type="button">Next →</button>
      </div>
      <div class="warn" id="skillsWarn">Pick at least one skill.</div>
    </section>

    <!-- S4: Interests -->
    <section class="step" id="s4">
      <div class="field">
        <div class="chips" id="hobbiesChips"></div>
        <div class="combo" id="hobbiesCombo">
          <input type="text" id="hobbiesInput" placeholder="Search interests…" autocomplete="off">
          <div class="menu" id="hobbiesMenu"></div>
        </div>
        <div class="hint">We use this for communities and side-quest matches. <span class="limit" id="hobbiesLimit">0 / 5 selected</span></div>
      </div>
      <div class="actions">
        <button class="btn ghost" data-back type="button">Back</button>
        <div style="flex:1"></div>
        <button class="btn" id="toS5" type="button">Next →</button>
      </div>
    </section>

    <!-- S5: Summary -->
    <section class="step" id="s5">
      <div class="summary">
        <h3>Preview Profile</h3>
        <div class="row"><div><strong>Name</strong></div><div id="sumName">—</div></div>
        <div class="row"><div><strong>Industries</strong></div><div id="sumIndustries">—</div></div>
        <div class="row"><div><strong>Skills</strong></div><div id="sumSkills">—</div></div>
        <div class="row"><div><strong>Hobbies</strong></div><div id="sumHobbies">—</div></div>
        <div class="row">
          <div><strong>Professional</strong></div>
          <div id="proRow" class="proRow"></div>
        </div>
        <p>Want to unlock your <em>Adventurer Type</em>? Complete your profile and take a quick personality quest to see what class fits you best.</p>
      </div>
      <div class="actions" style="margin-top:12px">
        <button class="btn ghost" data-back type="button">Back</button>
        <div style="flex:1"></div>
        <button class="btn" id="finishBtn" type="button">Complete Profile →</button>
      </div>
    </section>
  </div>
</main>

<!-- Full-screen saving -->
<div class="saving" id="saving">
  <div class="savingInner"><div class="spinner"></div><div id="savingText">Saving…</div></div>
</div>

<script>
/* ---------- paths ---------- */
const PATHS = {
  sectors: 'data/sectors.json',
  skills: 'data/skills.json',
  interests: 'data/interests.json'
};

/* ---------- helpers ---------- */
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const norm = s => (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
function el(tag, attrs={}, ...children){
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k === 'class') n.className = v;
    else if (k === 'dataset') Object.assign(n.dataset, v);
    else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
    else if (v !== null && v !== undefined) n.setAttribute(k, v);
  }
  for (const c of children) n.appendChild(typeof c==='string' ? document.createTextNode(c) : c);
  return n;
}
async function safeJSON(path){
  try{ const res = await fetch(path, {cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); return await res.json(); }
  catch(e){ console.warn('Missing/bad JSON:', path, e.message); return []; }
}
const sleep = ms => new Promise(r=>setTimeout(r, ms));

/* ---------- state ---------- */
const STATE = { name:{ first:'', last:'', display:'' }, industries:[], skills:[], hobbies:[] };

/* ---------- saving ---------- */
function showSaving(text='Saving…'){ $('#savingText').textContent=text; $('#saving').classList.add('show'); }
function hideSaving(){ $('#saving').classList.remove('show'); }
function fakeSave(ms=650){ return new Promise(res=>setTimeout(res, ms)); }

/* ---------- narrator ---------- */
async function speak(line1='', line2='', dim=true){
  const t = $('#title'), s = $('#subtitle'), curtain = $('#curtain');
  curtain.classList.toggle('show', !!dim);
  if (line1){
    t.textContent = line1;
    if (!t.classList.contains('show')) { await sleep(20); t.classList.add('show'); }
  }
  s.textContent = ''; s.classList.remove('show');
  if (line2){ await sleep(900); s.textContent = line2; s.classList.add('show'); }
}

/* ---------- combo builder ---------- */
function makePicker({inputEl, menuEl, chipsEl, limit, source, labelKey, onAdd, onRemove, boost=[]}){
  let open=false; let items=[]; let lastQ='';

  function renderMenu(q=''){
    menuEl.innerHTML='';
    const nq = norm(q);
    let pool = items;

    if (!nq && boost.length){
      const set = new Set(boost.map(b=>b.toLowerCase()));
      pool = [...items].sort((a,b)=> (set.has(a[labelKey].toLowerCase())? -1:0) - (set.has(b[labelKey].toLowerCase())? -1:0));
    }
    let shown=0;
    for (const it of pool){
      const lbl = it[labelKey]; if (!lbl) continue;
      if (!nq || norm(lbl).includes(nq)){
        const btn = el('button', {type:'button', class:'item'} , lbl);
        btn.addEventListener('click', ()=> add(lbl, it));
        menuEl.appendChild(btn); if(++shown>=300) break;
      }
    }
    if (shown===0) menuEl.appendChild(el('div',{class:'item', style:'opacity:.55; pointer-events:none'}, 'No matches'));
  }
  function openMenu(){ inputEl.parentElement.classList.add('open'); open=true; renderMenu(inputEl.value); }
  function closeMenu(){ inputEl.parentElement.classList.remove('open'); open=false; }
  function promoteToTop(label){
    const i = items.findIndex(x => (x[labelKey]||'') === label);
    if (i > 0){ const [picked] = items.splice(i,1); items.unshift(picked); }
  }
  function add(label, obj){
    promoteToTop(label); renderMenu(inputEl.value);
    const arr = onAdd(label, obj);
    updateChips(arr); updateCounter();
    inputEl.value=''; inputEl.focus();
    if (arr.length>=limit) closeMenu();
  }
  function remove(label){ const arr = onRemove(label); updateChips(arr); updateCounter(); }
  function updateChips(arr){
    chipsEl.innerHTML='';
    for (const v of arr){
      const chip = el('span',{class:'chip'}, v.label||v);
      chip.appendChild(el('button',{onclick:()=>remove(v.label||v)}, '✕'));
      chipsEl.appendChild(chip);
    }
  }
  function updateCounter(){
    const id = chipsEl.id.replace('Chips','Limit');
    const limEl = document.getElementById(id);
    const count = chipsEl.children.length;
    if (limEl) limEl.textContent = `${count} / ${limit} selected`;
  }
  function onDocClick(e){ if (!inputEl.parentElement.contains(e.target)) closeMenu(); }

  (async()=>{ const raw = await source(); items = Array.isArray(raw)? raw: []; })();

  inputEl.addEventListener('focus', openMenu);
  inputEl.addEventListener('input', ()=>{ if(!open) openMenu(); const q=inputEl.value; if(q!==lastQ){ lastQ=q; renderMenu(q);} });
  inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeMenu(); inputEl.blur(); }});
  document.addEventListener('mousedown', onDocClick);

  return { updateChips, updateCounter, add, remove, promoteToTop };
}

/* ---------- professional images ---------- */
const proSrc = (code, sex) => `assets/professional/${code}_${sex}_sea.png`;

function renderProStage(){
  const stage = $('#proStage'); stage.innerHTML='';
  const picks = STATE.industries.filter(x=> x.Code && String(x.Code).trim()).slice(0,2);
  if (!picks.length){ stage.classList.remove('show'); return; }
  const add = (code, sex)=>{ const img = new Image(); img.src = proSrc(code, sex); img.alt = `${code} ${sex}`; img.onerror=()=>img.remove(); stage.appendChild(img); };
  add(picks[0].Code,'m'); add(picks[0].Code,'f'); if (picks[1]){ add(picks[1].Code,'m'); add(picks[1].Code,'f'); }
  stage.classList.add('show');
}
function renderProRow(){
  const row = $('#proRow'); if(!row) return; row.innerHTML='';
  const picks = STATE.industries.filter(x=> x.Code && String(x.Code).trim()).slice(0,2);
  const add = (code, sex)=>{ const img = new Image(); img.src = proSrc(code, sex); img.alt = `${code} ${sex}`; img.onerror=()=>img.remove(); row.appendChild(img); };
  if (!picks.length) return;
  add(picks[0].Code,'m'); add(picks[0].Code,'f'); if (picks[1]){ add(picks[1].Code,'m'); add(picks[1].Code,'f'); }
}

/* ---------- boot ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  const steps = ['s1','s2','s3','s4','s5']; // s0 is the hero stack
  let idx = 0;

  function updateDots(){ $$('.dot').forEach((d,j)=> d.classList.toggle('active', j===idx)); }
  function show(stepIndex){
    idx = Math.max(0, Math.min(stepIndex, steps.length-1));
    steps.forEach((id,j)=>{ document.getElementById(id).classList.toggle('show', j===idx); });
    updateDots();
    $('#proStage').classList.toggle('show', (idx>=3) && STATE.industries.length>0); // show on interests & summary
    if (idx>=3) renderProStage();
    runNarration();
  }

  /* ------------ Splash choreography (NO DASH, no layout shift) ------------ */
  const line = $('#s0Line'); const cta = $('#s0CTA');
  line.classList.add('show');               // fade in title
  setTimeout(()=>{ line.classList.remove('show'); }, 1400); // fade out title
  setTimeout(()=>{ cta.classList.add('show'); }, 1700);     // fade in CTA at same spot

  $('#goS1').addEventListener('click', ()=>{
    $('#s0').style.display='none'; // hide hero stack after start
    show(0); // go to step 1 (index 0 in steps)
  });

  /* ----------------- Data sources ----------------- */
  const sectorsSource = async ()=>{
    const data = await safeJSON(PATHS.sectors);
    return data.map(row=>({
      label:(row.Sector||row.sector||row.name||row.SectorName||'').trim(),
      SectorCode: row.SectorCode || row.sectorCode || '',
      IndustryCode: row.IndustryCode || row.industryCode || '',
      Code: (row.Code || row.code || '').trim()
    })).filter(x=>x.label).sort((a,b)=> a.label.localeCompare(b.label));
  };
  const skillsSource = async ()=>{
    const data = await safeJSON(PATHS.skills);
    return data.map(x=>({label: x.Skill || x.skill || x.name || ''})).filter(x=>x.label).sort((a,b)=> a.label.localeCompare(b.label));
  };
  const hobbiesSource = async ()=>{
    const data = await safeJSON(PATHS.interests);
    return data.map(x=>({label: x.Interest || x.interest || x.name || ''})).filter(x=>x.label).sort((a,b)=> a.label.localeCompare(b.label));
  };
  const pmBoost = ['Project Management','Agile','Scrum Master','Product Owner','Business Analysis','Program Management'];

  /* ----------------- Pickers ----------------- */
  const industriesPicker = makePicker({
    inputEl: $('#industriesInput'), menuEl: $('#industriesMenu'), chipsEl: $('#industriesChips'),
    limit: 5, source: sectorsSource, labelKey: 'label',
    onAdd: (label, obj)=>{ if (STATE.industries.find(x=> (x.label||x)===label) || STATE.industries.length>=5) return STATE.industries;
                           STATE.industries = [{...obj}, ...STATE.industries]; persist(); renderProStage(); return STATE.industries; },
    onRemove: (label)=>{ STATE.industries = STATE.industries.filter(x=> (x.label||x)!==label); persist(); renderProStage(); return STATE.industries; },
    boost: ['Information Technology','Business Services','Financial Services','E-commerce','Education & Training']
  });
  const skillsPicker = makePicker({
    inputEl: $('#skillsInput'), menuEl: $('#skillsMenu'), chipsEl: $('#skillsChips'),
    limit: 7, source: skillsSource, labelKey: 'label',
    onAdd: (label)=>{ if (STATE.skills.includes(label) || STATE.skills.length>=7) return STATE.skills.map(l=>({label:l}));
                      STATE.skills = [label, ...STATE.skills]; persist(); return STATE.skills.map(l=>({label:l})); },
    onRemove: (label)=>{ STATE.skills = STATE.skills.filter(x=> x!==label); persist(); return STATE.skills.map(l=>({label:l})); },
    boost: pmBoost
  });
  const hobbiesPicker = makePicker({
    inputEl: $('#hobbiesInput'), menuEl: $('#hobbiesMenu'), chipsEl: $('#hobbiesChips'),
    limit: 5, source: hobbiesSource, labelKey: 'label',
    onAdd: (label)=>{ if (STATE.hobbies.includes(label) || STATE.hobbies.length>=5) return STATE.hobbies.map(l=>({label:l}));
                      STATE.hobbies = [label, ...STATE.hobbies]; persist(); return STATE.hobbies.map(l=>({label:l})); },
    onRemove: (label)=>{ STATE.hobbies = STATE.hobbies.filter(x=> x!==label); persist(); return STATE.hobbies.map(l=>({label:l})); }
  });

  /* ----------------- Guards + flow ----------------- */
  async function isDisplayNameTaken(name){
    const blocked = new Set(['admin','test','demo','jm','user','guest']); await sleep(350);
    return blocked.has((name||'').trim().toLowerCase());
  }

  $('#toS2').addEventListener('click', async ()=>{
    const f = $('#firstName').value.trim(), l = $('#lastName').value.trim(), d = $('#displayName').value.trim();
    $('#nameWarn').classList.remove('show'); $('#nameTaken').style.display='none'; $('#displayName').classList.remove('is-error');
    if (!f && !d){ $('#nameWarn').classList.add('show'); return; }
    if (d){ showSaving('Checking name…'); if (await isDisplayNameTaken(d)){ hideSaving(); $('#nameTaken').style.display='block'; $('#displayName').classList.add('is-error'); $('#displayName').focus(); return; } hideSaving(); }
    STATE.name = { first:f, last:l, display: d || `${f}${l? ' '+l:''}` }; persist();
    showSaving('Saving profile…'); await fakeSave(); hideSaving(); show(1);
  });

  $('#toS3').addEventListener('click', async ()=>{ if (STATE.industries.length<1){ $('#industriesWarn').classList.add('show'); return; } $('#industriesWarn').classList.remove('show'); showSaving('Saving choices…'); await fakeSave(); hideSaving(); show(2); });
  $('#toS4').addEventListener('click', async ()=>{ if (STATE.skills.length<1){ $('#skillsWarn').classList.add('show'); return; } $('#skillsWarn').classList.remove('show'); showSaving('Saving skills…'); await fakeSave(); hideSaving(); show(3); });
  $('#toS5').addEventListener('click', async ()=>{ showSaving('Saving interests…'); await fakeSave(); hideSaving(); updateSummary(); renderProRow(); renderProStage(); show(4); });
  $('#finishBtn').addEventListener('click', ()=>{ persist(); window.location.href='complete-profile.html'; });

  /* ----------------- Narration per step ----------------- */
  async function runNarration(){
    const curtain = $('#curtain');
    if (idx===0){ // Name
      curtain.classList.add('show');
      await speak("First things first: your name.", "", true);
      await sleep(650); $('#nameRow').style.display='grid';
      await sleep(500); await speak("", "How should we address you?");
      $('#displayWrap').style.display='block';
    }
    if (idx===1){ const who = STATE.name.display || STATE.name.first || 'Adventurer'; await speak(`Nice to meet you, ${who}!`, "Which industries are you aiming for?", true); }
    if (idx===2){ await speak("Sharpen your toolkit.","Pick the professional skills you want to use or grow.", true); }
    if (idx===3){ await speak("We’re almost done.","What hobbies or interests energize you?", true); }
    if (idx===4){ await speak("All set.","Here’s a quick preview — you can tweak anything.", false); }
  }

  /* ----------------- Summary ----------------- */
  function updateSummary(){
    $('#sumName').textContent = STATE.name.display || [STATE.name.first, STATE.name.last].filter(Boolean).join(' ') || '—';
    $('#sumIndustries').textContent = STATE.industries.map(x=>x.label||x).join(', ') || '—';
    $('#sumSkills').textContent = STATE.skills.join(', ') || '—';
    $('#sumHobbies').textContent = STATE.hobbies.join(', ') || '—';
  }

  /* ----------------- Persistence ----------------- */
  function persist(){
    const vg = JSON.parse(localStorage.getItem('vg_user')||'{}');
    vg.name = STATE.name; vg.industries = STATE.industries; vg.skills = STATE.skills; vg.hobbies = STATE.hobbies;
    localStorage.setItem('vg_user', JSON.stringify(vg));
  }
  (function hydrate(){
    const vg = JSON.parse(localStorage.getItem('vg_user')||'{}');
    if (vg.name){ STATE.name = vg.name; $('#firstName').value = vg.name.first||''; $('#lastName').value = vg.name.last||''; $('#displayName').value = vg.name.display||''; }
    if (Array.isArray(vg.industries)) STATE.industries = vg.industries;
    if (Array.isArray(vg.skills)) STATE.skills = vg.skills;
    if (Array.isArray(vg.hobbies)) STATE.hobbies = vg.hobbies;
  })();
});
</script>
</body>
</html>
