<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>VENGUILD â€“ Interactive Signup</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Oswald:wght@500;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --text:#ffffff;--muted:#e6edf4;--gold:#f6d694;--accent:#39e27e;--danger:#ff6b6b;
    --overlay:linear-gradient(180deg, rgba(8,12,16,.65), rgba(8,12,16,.75) 40%, rgba(8,12,16,.85));
    --glass:rgba(9,12,16,.55);--glass-strong:rgba(9,12,16,.78);--border:rgba(255,255,255,.18);
    --shadow:0 22px 60px rgba(0,0,0,.5);--glow:0 0 22px rgba(57,226,126,.45), 0 0 7px rgba(57,226,126,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--overlay), url('assets/background/background1.png') center center / cover no-repeat fixed;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    -webkit-touch-callout:none; /* kill iOS paste bar globally */
  }
  body.lock{height:100%;overflow:hidden;position:fixed;width:100%}

  /* ========= SCREENS + FADE-OUT ONLY ========= */
  .screen{min-height:100svh;display:none;align-items:center;justify-content:center;padding:56px 20px 120px}
  .screen.active{display:flex}
  .fadeout{transition:opacity .38s ease}

  .stack{width:min(1180px, 94vw); margin:0 auto}
  .spacer{height:28px}.big-space{height:42px}.xl-space{height:64px}

  .h1{font-family:Cinzel,serif;font-weight:900;letter-spacing:.3px;font-size:clamp(32px,5.2vw,60px);line-height:1.05;text-align:center}
  .h2{font-family:Cinzel,serif;font-weight:800;font-size:clamp(22px,3.6vw,38px);text-align:center;color:var(--gold)}
  .lead{font-size:clamp(16px,2.1vw,20px);color:var(--muted);text-align:center}

  label{display:block;margin:0 0 8px 6px;font-size:14px;color:var(--muted)}
  .row{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:14px;justify-content:center}
  @media (max-width:860px){.row{grid-template-columns:1fr 1fr}}
  @media (max-width:560px){.row{grid-template-columns:1fr}}

  /* Gender/Country row controls */
  .gc-row{grid-template-columns:repeat(2,minmax(260px,420px))}
  @media (max-width:768px){ .gc-row{grid-template-columns:1fr !important} }

  input[type=text], .fake-select{
    width:100%;padding:14px;border-radius:12px;border:1px solid var(--border);
    background:var(--glass);color:var(--text);outline:none;backdrop-filter:blur(4px);
    transition:border-color .25s ease, box-shadow .25s ease, background .25s ease;
    font-size:16px; /* >=16px to stop iOS zoom */
  }
  input[type=text]::placeholder{color:#c5d0da}
  input[type=text]:focus{border-color:rgba(57,226,126,.65);box-shadow:0 0 0 3px rgba(57,226,126,.15)}

  .fake-select{cursor:pointer;user-select:none}
  .fake-select:focus{border-color:rgba(57,226,126,.65);box-shadow:0 0 0 3px rgba(57,226,126,.15)}

  .chips{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:14px}
  .chip{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:rgba(57,226,126,.18);border:1px solid rgba(57,226,126,.38);font-size:14px;color:#0a1913}
  .chip button{background:transparent;border:none;color:#091612;cursor:pointer;padding:0}

  .actions{display:flex;gap:12px;justify-content:center;margin-top:18px}
  .btn{background:linear-gradient(180deg,#38e07d,#1fb866);color:#06130d;font-weight:800;padding:14px 18px;border:none;border-radius:12px;cursor:pointer;transition:opacity .2s ease, transform .12s ease, box-shadow .2s ease;box-shadow:0 4px 16px rgba(57,226,126,.2)}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(57,226,126,.32)}
  .btn.secondary{background:var(--glass);color:var(--text);border:1px solid var(--border)}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .warn{color:var(--danger);text-align:center;margin-top:8px;font-weight:700}

  .grid{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:16px}
  @media (max-width:860px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}

  .card{position:relative;display:flex;gap:16px;align-items:center;padding:16px;border-radius:16px;cursor:pointer;border:1px solid var(--border);background:var(--glass);backdrop-filter:blur(4px);transition:transform .12s ease,border-color .12s ease,box-shadow .12s ease;color:#fff}
  .card:hover{transform:translateY(-2px);border-color:rgba(57,226,126,.55);box-shadow:var(--glow)}
  .card[aria-pressed="true"]{outline:2px solid rgba(57,226,126,.7);box-shadow:var(--glow)}
  .silhouette{filter:brightness(.95) saturate(110%)}
  .tip{font-size:13px;color:#f7fbff;opacity:.95;margin-top:4px}

  .hero-wrap{display:flex;align-items:stretch;justify-content:center}
  .hero-card{max-width:880px;width:100%;background:linear-gradient(180deg, rgba(10,18,24,.75), rgba(10,18,24,.92));border:1px solid var(--border);box-shadow:0 18px 60px rgba(0,0,0,.55), var(--glow);border-radius:18px;padding:22px;display:grid;grid-template-columns:auto 1fr;gap:20px}
  .hero-img{width:160px;height:160px;border-radius:16px;object-fit:contain;background:rgba(255,255,255,.06);padding:8px}
  .hero-name{font-family:Cinzel,serif;font-weight:900;font-size:clamp(28px,4.6vw,44px);line-height:1.05}
  .hero-desc{font-size:15px;color:#f3fbff;opacity:.97;margin-top:8px}

  .trans-cols{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:26px}
  @media (max-width:560px){.trans-cols{grid-template-columns:1fr 1fr}}

  .arrow-down{height:36px;display:flex;align-items:center;justify-content:center;margin:6px 0 10px;filter:drop-shadow(0 0 8px rgba(57,226,126,.55)) drop-shadow(0 0 2px rgba(57,226,126,.55))}
  .arrow-down svg{width:42px;height:36px}
  .arrow-down path{stroke:#39e27e;stroke-width:6;fill:none;stroke-linecap:round;stroke-linejoin:round}

  .mini-card{cursor:default}
  .mini-card img{width:96px;height:96px;border-radius:12px;object-fit:contain;background:rgba(255,255,255,.06);padding:6px}
  .mini-title{font-weight:900}
  .tooltip{position:absolute;left:16px;right:16px;bottom:100%;transform:translateY(-10px);background:rgba(8,12,16,.96);border:1px solid var(--border);padding:10px 12px;border-radius:12px;font-size:13px;color:#f7fbff;line-height:1.35;display:none;box-shadow:var(--shadow)}
  .mini-card:hover .tooltip{display:block}

  @media (max-width:820px){#final .grid{grid-template-columns:1fr !important}}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:200}
  .modal.show{display:flex}
  .modal-bg{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
  .modal-card{position:relative;padding:22px;border-radius:14px;border:1px solid var(--border);background:rgba(9,12,16,.92);width:min(520px,92vw)}
  .loader{height:8px;width:100%;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden}
  .loader::after{content:"";display:block;height:100%;width:40%;background:linear-gradient(90deg,transparent,rgba(57,226,126,.6),transparent);animation:loadbar 1.2s linear infinite}
  @keyframes loadbar{from{margin-left:-40%} to{margin-left:100%}}

  .saving{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:300}
  .saving.show{display:flex}
  .save-inner{position:relative;width:220px;height:220px;display:grid;place-items:center}
  .save-inner::before{content:"";position:absolute;inset:-30px;border-radius:50%;background:radial-gradient(circle, rgba(57,226,126,.35), transparent 60%);filter:blur(18px);animation:pulse 1.8s ease-in-out infinite}
  .save-inner img{width:140px;height:140px;object-fit:contain;filter:drop-shadow(0 0 20px rgba(57,226,126,.6))}
  @keyframes pulse{0%,100%{opacity:.5;transform:scale(.98)}50%{opacity:1;transform:scale(1.03)}}

  .stepper{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:12px;z-index:180;pointer-events:none}
  .stepper .logo{width:72px;height:72px;object-fit:contain;filter:drop-shadow(0 0 12px rgba(0,0,0,.35))}
  .dots{display:flex;gap:14px;align-items:center}
  .dot{width:16px;height:16px;border-radius:50%;background:rgba(255,255,255,.22);box-shadow:0 0 0 2px rgba(0,0,0,.25) inset}
  .dot.active{background:#39e27e;box-shadow:0 0 16px rgba(57,226,126,.8), 0 0 0 2px rgba(0,0,0,.25) inset}

  /* === CENTERED COMBO OVERLAY === */
  .combo{position:fixed;inset:0;display:none;place-items:center;z-index:260}
  .combo.show{display:grid}
  .combo-bg{position:absolute;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(3px)}
  .combo-card{position:relative;width:min(560px,92vw);max-height:76vh;display:grid;grid-template-rows:auto 1fr auto;gap:12px;background:rgba(9,12,16,.95);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px}
  .combo-title{font-weight:900;font-size:18px}
  .combo-input{padding:14px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:#fff;outline:none;font-size:16px}
  .combo-input::placeholder{color:#cfe1ef}
  .combo-list{overflow:auto;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.04)}
  .combo-item{padding:14px;cursor:pointer}
  .combo-item:hover,.combo-item[aria-selected="true"]{background:rgba(57,226,126,.10)}
  .combo-actions{display:flex;justify-content:flex-end;gap:8px}
  .combo *{-webkit-touch-callout:none}
  .combo-input{-webkit-touch-callout:none}
  .combo-list, .combo-item{user-select:none;-webkit-user-select:none}
</style>
</head>
<body>

<!-- STEP 1 -->
<section id="step-1" class="screen active">
  <div class="stack" style="text-align:center">
    <div class="h1">Greatâ€”Youâ€™re In!</div>
    <div class="spacer"></div>
    <p class="lead" style="max-width:760px;margin:0 auto">Letâ€™s set up your identity and see which adventurer archetype fits you best.</p>
    <div class="xl-space"></div>
    <button class="btn" id="goNextFromGreeting">Next Steps</button>
  </div>
</section>

<!-- STEP 2 -->
<section id="step-2" class="screen">
  <div class="stack" id="nameStage1">
    <div class="h1">First things first, what should we call you?</div>
    <div class="big-space"></div>
    <div class="row">
      <div><label for="firstName">First Name</label><input id="firstName" type="text" autocomplete="given-name" placeholder="First name"></div>
      <div><label for="lastName">Last Name</label><input id="lastName" type="text" autocomplete="family-name" placeholder="Last name"></div>
      <div><label for="middleInitial">Middle Initial <span style="opacity:.9">(optional)</span></label><input id="middleInitial" type="text" maxlength="3" placeholder="M."></div>
    </div>
    <div class="actions"><button class="btn" id="toStage2">Continue</button></div>
    <div class="warn" id="warnStage1" style="display:none">Please enter First and Last name.</div>
  </div>

  <div class="stack" id="nameStage2" style="display:none">
    <div class="h1">Okay great! Thanks for that. How should we call you?</div>
    <div class="big-space"></div>
    <div class="row" style="grid-template-columns:minmax(260px,420px)">
      <div><label for="displayName">Display Name</label><input id="displayName" type="text" placeholder="This is how others will see you" autocomplete="nickname"></div>
    </div>
    <div class="actions"><button class="btn secondary" id="backTo1">Back</button><button class="btn" id="toStage3">Continue</button></div>
    <div class="warn" id="warnStage2" style="display:none">Please provide a display name.</div>
  </div>

  <div class="stack" id="nameStage3" style="display:none">
    <div class="h1">Just a few things to understand your character.</div>
    <div class="big-space"></div>

    <!-- Gender & Country (stack on mobile) -->
    <div id="stackGC">
      <div class="row gc-row">
        <div>
          <label>Gender</label>
          <input id="genderTrigger" class="fake-select" type="text" placeholder="Selectâ€¦" readonly>
        </div>
        <div>
          <label>Country</label>
          <input id="countryTrigger" class="fake-select" type="text" placeholder="Selectâ€¦" readonly>
        </div>
      </div>
    </div>

    <div class="actions"><button class="btn secondary" id="backTo2">Back</button><button class="btn" id="finishIdentity">Continue</button></div>
    <div class="warn" id="warnStage3" style="display:none">Please select a country.</div>
  </div>

  <div class="stack" id="nameHello" style="display:none">
    <div class="h1" id="helloText">Nice to meet you, Traveler.</div>
  </div>
</section>

<!-- STEP 3 -->
<section id="step-3" class="screen">
  <div class="stack">
    <div class="h1">What kind of jobs are you aiming for, or open to exploring?</div>
    <div class="xl-space"></div>
    <div id="jobsChips" class="chips"></div>
    <div><input id="jobsTrigger" class="fake-select" type="text" placeholder="Tap to choose jobsâ€¦" readonly></div>
    <div class="actions"><button class="btn secondary" data-prev>Back</button><button class="btn" data-next>Continue</button></div>
    <div class="warn" id="jobsWarn" style="display:none">Select at least one job.</div>
  </div>
</section>

<!-- STEP 4 -->
<section id="step-4" class="screen">
  <div class="stack">
    <div class="h1">Which professional skills do you want to use, or grow stronger in?</div>
    <div class="xl-space"></div>
    <div id="skillsChips" class="chips"></div>
    <div><input id="skillsTrigger" class="fake-select" type="text" placeholder="Tap to choose skillsâ€¦" readonly></div>
    <div class="actions"><button class="btn secondary" data-prev>Back</button><button class="btn" data-next>Continue</button></div>
    <div class="lead" id="skillsNote" style="display:none">Youâ€™ve picked 5 already. Add more if you like, but we recommend focusing on five.</div>
  </div>
</section>

<!-- STEP 5 -->
<section id="step-5" class="screen">
  <div class="stack">
    <div class="h1">What do you enjoy doing beyond your professional life?</div>
    <div class="xl-space"></div>
    <div id="interestsChips" class="chips"></div>
    <div><input id="interestsTrigger" class="fake-select" type="text" placeholder="Tap to choose interestsâ€¦" readonly></div>
    <div class="actions"><button class="btn secondary" data-prev>Back</button><button class="btn" data-next>Continue</button></div>
  </div>
</section>

<!-- STEP 6 -->
<section id="step-6" class="screen">
  <div class="stack">
    <div class="h1">If you were transported into a fantasy world, who would you be?</div>
    <div class="big-space"></div>

    <div class="h2">Choose a Job Type</div>
    <div class="big-space"></div>
    <div><input id="typeTrigger" class="fake-select" type="text" placeholder="Tap to choose job typeâ€¦" readonly></div>

    <div class="xl-space"></div>
    <div class="h2">Available Base Classes</div>
    <div class="big-space"></div>
    <div id="advGrid" class="grid"></div>
    <div class="warn" id="advWarn" style="display:none">Please choose a class.</div>

    <div class="xl-space"></div>
    <div id="advTransitions" style="display:none"></div>

    <div class="actions">
      <button class="btn secondary" id="advBack">Back</button>
      <button class="btn" id="advProceed">Proceed</button>
      <button class="btn secondary" id="advExplore" style="display:none">Explore more</button>
    </div>
  </div>
</section>

<!-- FINAL -->
<section id="final" class="screen">
  <div class="stack">
    <div class="h1">All set, <span id="finalName"></span>.</div>
    <div class="spacer"></div>
    <div class="h2">See your perfect fantasy role. Complete your profile to unlock Founding Adventurer perks: early news, employer calls, and tools to connect.</div>
    <div class="xl-space"></div>

    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div><div class="h2">Professional Card</div><div id="cardPro"></div></div>
      <div><div class="h2">Adventurer Card</div><div id="cardAdv"></div></div>
    </div>

    <div class="actions">
      <button class="btn secondary" onclick="goTo(3)">Edit selections</button>
      <button class="btn" id="completeProfileBtn">Complete Profile</button>
    </div>
  </div>
</section>

<!-- Confirm modal -->
<div id="confirmModal" class="modal">
  <div class="modal-bg"></div>
  <div class="modal-card">
    <div class="h2" style="margin:0 0 12px">Proceed with this class?</div>
    <p class="lead" style="margin:0 0 18px">You can still come back and explore again later.</p>
    <div class="actions" style="margin-bottom:14px">
      <button class="btn secondary" id="cancelProceed">Cancel</button>
      <button class="btn" id="confirmProceed">Yes, continue</button>
    </div>
    <div id="loader" class="loader" style="display:none"></div>
  </div>
</div>

<!-- Saving overlay -->
<div id="saving" class="saving"><div class="save-inner"><img src="assets/logo.png" alt="VENGUILD"></div></div>

<!-- Stepper bottom -->
<div id="stepper" class="stepper" aria-hidden="false">
  <img class="logo" src="assets/logo.png" alt="VENGUILD">
  <div class="dots" id="dots"></div>
</div>

<!-- Centered Combo Overlay (search + list) -->
<div id="combo" class="combo" role="dialog" aria-modal="true" aria-labelledby="comboTitle">
  <div class="combo-bg"></div>
  <div class="combo-card">
    <div id="comboTitle" class="combo-title">Choose</div>
    <input id="comboInput" class="combo-input" type="text" inputmode="search" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" placeholder="Type here to filterâ€¦">
    <div id="comboList" class="combo-list" role="listbox"></div>
    <div class="combo-actions"><button id="comboClose" class="btn secondary" type="button">Close</button></div>
  </div>
</div>

<script>
/* ---------- Fade-out between screens ---------- */
function goTo(step){
  const current=document.querySelector('.screen.active');
  const target=(step==='final')?document.querySelector('#final'):document.querySelector(`#step-${step}`);
  if(!target||current===target) return;
  current.classList.add('fadeout'); current.style.opacity='1';
  requestAnimationFrame(()=> current.style.opacity='0');
  setTimeout(()=>{ current.style.opacity=''; current.classList.remove('fadeout','active'); target.classList.add('active'); updateDots(); },390);
}
function warn(el, show){ el.style.display = show ? '' : 'none'; }

/* ---------- Stepper ---------- */
const ORDER=['step-1','step-2','step-3','step-4','step-5','step-6','final'];
const dotsWrap=document.getElementById('dots');
function buildDots(){ dotsWrap.innerHTML=''; for(let i=0;i<ORDER.length;i++){ const d=document.createElement('span'); d.className='dot'; dotsWrap.appendChild(d);} }
function updateDots(){ const active=document.querySelector('.screen.active'); const idx=ORDER.indexOf(active?.id); [...document.querySelectorAll('.dot')].forEach((d,i)=> d.classList.toggle('active', i===idx)); }
buildDots();

/* ---------- STATE ---------- */
const S = JSON.parse(localStorage.getItem('vg_signup_state')||'{}');
S.step??=1; S.jobs??=[]; S.skills??=[]; S.interests??=[]; S.gender??=''; S.country??=''; S.displayName??=''; S.firstName??=''; S.lastName??=''; S.middleInitial??=''; S.archetype??=null; S.jobType??='';
function save(){ localStorage.setItem('vg_signup_state', JSON.stringify(S)); }
function $(s, r=document){ return r.querySelector(s); }

/* ---------- Greeting ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelector('#step-1').classList.add('active');
  updateDots();
  $('#goNextFromGreeting').addEventListener('click', ()=> goTo(2));
});

/* ---------- Combo Overlay ---------- */
const Combo = (()=>{
  const root = $('#combo'), input = $('#comboInput'), list = $('#comboList'), title = $('#comboTitle');
  let current = { data:[], onPick:()=>{}, multi:false, selected: new Set() };

  function open({titleText, data, onPick, multi=false, preselected=[]}){
    title.textContent = titleText || 'Choose';
    current = { data, onPick, multi, selected: new Set(preselected||[]) };
    render('');
    root.classList.add('show'); document.body.classList.add('lock');
    input.value=''; input.focus({preventScroll:true});
  }
  function close(){ root.classList.remove('show'); document.body.classList.remove('lock'); }

  function render(q){
    list.innerHTML='';
    const norm = s=> (s||'').toLowerCase();
    const arr = (q? current.data.filter(o=>norm(o.label).includes(norm(q))) : current.data).slice(0,300);
    for(const o of arr){
      const item = document.createElement('div'); item.className='combo-item'; item.textContent=o.label; item.tabIndex=0;
      item.setAttribute('role','option');
      if(current.selected.has(o.label)) item.setAttribute('aria-selected','true');
      item.onclick=()=> pick(o);
      item.onkeydown=e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); pick(o);} };
      list.appendChild(item);
    }
  }
  function pick(o){
    if(current.multi){
      if(current.selected.has(o.label)) current.selected.delete(o.label); else current.selected.add(o.label);
      render(input.value);
      current.onPick(Array.from(current.selected));
    }else{
      current.onPick(o.label);
      close();
    }
  }
  input.addEventListener('input', ()=> render(input.value));
  $('#comboClose').addEventListener('click', close);
  root.addEventListener('click', e=>{ if(e.target.classList.contains('combo-bg')) close(); });
  document.addEventListener('keydown', e=>{ if(root.classList.contains('show') && e.key==='Escape') close(); });
  document.addEventListener('contextmenu', e=>{ if(root.classList.contains('show')) e.preventDefault(); }, {capture:true});

  return { open, close };
})();

/* ---------- Data helpers ---------- */
async function j(path, fallback){ try{ const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json(); } catch{ return fallback||[]; } }
const FB_GENDER=[{label:'Male'},{label:'Female'},{label:'Non-binary'},{label:'Prefer not to say'}];
const FB_COUNTRIES=[{label:'Philippines'},{label:'United States'},{label:'Singapore'},{label:'United Arab Emirates'},{label:'Japan'},{label:'United Kingdom'}];
const FB_JOBS=[{label:'Frontend Developer'},{label:'Project Manager'},{label:'Data Analyst'},{label:'Graphic Designer'},{label:'Sales Executive'}];
const FB_SKILLS=[{label:'Project Management'},{label:'JavaScript'},{label:'UI/UX Design'},{label:'SQL'},{label:'Communication'}];
const FB_INTERESTS=[{label:'Photography'},{label:'Music'},{label:'Fitness'},{label:'Gaming'},{label:'Reading'}];

/* ---------- STEP 2 ---------- */
(async function step2(){
  $('#toStage2').onclick = ()=>{
    S.firstName = $('#firstName').value.trim();
    S.lastName  = $('#lastName').value.trim();
    S.middleInitial = $('#middleInitial').value.trim();
    if(!S.firstName || !S.lastName){ warn($('#warnStage1'), true); return; }
    warn($('#warnStage1'), false);
    $('#nameStage1').style.display='none';
    $('#nameStage2').style.display='block';
  };
  $('#backTo1').onclick = ()=>{ $('#nameStage2').style.display='none'; $('#nameStage1').style.display='block'; };
  $('#toStage3').onclick = ()=>{
    S.displayName = $('#displayName').value.trim();
    if(!S.displayName){ warn($('#warnStage2'), true); return; }
    warn($('#warnStage2'), false);
    $('#nameStage2').style.display='none';
    $('#nameStage3').style.display='block';
  };
  $('#backTo2').onclick = ()=>{ $('#nameStage3').style.display='none'; $('#nameStage2').style.display='block'; };

  const countriesRaw = await j('data/country_ethnicity.json', []);
  const countries = countriesRaw.length ? countriesRaw.map(c=>({label:(c.name||c.country||'').toString()})).filter(c=>c.label) : FB_COUNTRIES;

  $('#genderTrigger').addEventListener('click', ()=>{
    Combo.open({
      titleText:'Select Gender',
      data: FB_GENDER,
      onPick:(label)=>{ S.gender=label; save(); $('#genderTrigger').value=label; }
    });
  });
  $('#countryTrigger').addEventListener('click', ()=>{
    Combo.open({
      titleText:'Select Country',
      data: countries,
      onPick:(label)=>{ S.country=label; save(); $('#countryTrigger').value=label; }
    });
  });

  $('#finishIdentity').onclick = ()=>{
    if(!($('#countryTrigger').value||'').trim()){ warn($('#warnStage3'), true); return; }
    warn($('#warnStage3'), false); save();
    $('#nameStage3').style.display='none'; $('#nameHello').style.display='block';
    $('#helloText').textContent = `Nice to meet you, ${S.displayName}.`;
    setTimeout(()=> goTo(3), 900);
  };

  if(S.firstName) $('#firstName').value=S.firstName;
  if(S.lastName)  $('#lastName').value=S.lastName;
  if(S.middleInitial) $('#middleInitial').value=S.middleInitial;
  if(S.displayName){ $('#displayName').value=S.displayName; $('#nameStage1').style.display='none'; $('#nameStage2').style.display='block'; }
  if(S.gender) $('#genderTrigger').value=S.gender;
  if(S.country) $('#countryTrigger').value=S.country;
})();

/* ---------- STEP 3 ---------- */
(async function step3(){
  const raw = await j('data/jobs.json', []);
  const jobs = (raw.length?raw.map(o=>({label:(o.Job||o.label||o.title||o.name||'').toString()})).filter(x=>x.label): FB_JOBS);
  const chips = $('#jobsChips');

  function renderChips(){
    chips.innerHTML='';
    S.jobs.forEach(lbl=>{
      const c=document.createElement('span'); c.className='chip';
      c.innerHTML=`<span>${lbl}</span><button aria-label="Remove">Ã—</button>`;
      c.querySelector('button').onclick=()=>{ S.jobs=S.jobs.filter(x=>x!==lbl); save(); renderChips(); };
      chips.appendChild(c);
    });
  }
  renderChips();

  $('#jobsTrigger').addEventListener('click', ()=>{
    Combo.open({
      titleText:'Add Jobs (tap to toggle)',
      data: jobs,
      multi: true,
      preselected: S.jobs,
      onPick:(arr)=>{ S.jobs = arr; save(); renderChips(); }
    });
  });

  $('#step-3 [data-prev]').onclick = ()=> goTo(2);
  $('#step-3 [data-next]').onclick = ()=>{ if(S.jobs.length<1){ warn($('#jobsWarn'), true); return; } warn($('#jobsWarn'), false); goTo(4); };
})();

/* ---------- STEP 4 ---------- */
(async function step4(){
  const raw = await j('data/skills.json', []);
  const skills = (raw.length?raw.map(o=>({label:(o.Skill||o.label||'').toString()})).filter(x=>x.label): FB_SKILLS);
  const chips = $('#skillsChips');

  function render(){
    chips.innerHTML='';
    S.skills.forEach(lbl=>{
      const c=document.createElement('span'); c.className='chip';
      c.innerHTML=`<span>${lbl}</span><button aria-label="Remove">Ã—</button>`;
      c.querySelector('button').onclick=()=>{ S.skills=S.skills.filter(x=>x!==lbl); save(); render(); note(); };
      chips.appendChild(c);
    });
  }
  function note(){ $('#skillsNote').style.display = S.skills.length>5 ? '' : 'none'; }
  render(); note();

  $('#skillsTrigger').addEventListener('click', ()=>{
    Combo.open({
      titleText:'Add Skills (tap to toggle)',
      data: skills,
      multi: true,
      preselected: S.skills,
      onPick:(arr)=>{ S.skills = arr; save(); render(); note(); }
    });
  });

  $('#step-4 [data-prev]').onclick = ()=> goTo(3);
  $('#step-4 [data-next]').onclick = ()=> goTo(5);
})();

/* ---------- STEP 5 ---------- */
(async function step5(){
  const raw = await j('data/interests.json', []);
  const interests = (raw.length?raw.map(o=>({label:(o.Interest||o.label||'').toString()})).filter(x=>x.label): FB_INTERESTS);
  const chips = $('#interestsChips');

  function render(){
    chips.innerHTML='';
    S.interests.forEach(lbl=>{
      const c=document.createElement('span'); c.className='chip';
      c.innerHTML=`<span>${lbl}</span><button aria-label="Remove">Ã—</button>`;
      c.querySelector('button').onclick=()=>{ S.interests=S.interests.filter(x=>x!==lbl); save(); render(); };
      chips.appendChild(c);
    });
  }
  render();

  $('#interestsTrigger').addEventListener('click', ()=>{
    Combo.open({
      titleText:'Add Interests (tap to toggle)',
      data: interests,
      multi: true,
      preselected: S.interests,
      onPick:(arr)=>{ S.interests = arr; save(); render(); }
    });
  });

  $('#step-5 [data-prev]').onclick = ()=> goTo(4);
  $('#step-5 [data-next]').onclick = ()=> goTo(6);
})();

/* ---------- STEP 6 ---------- */
(async function step6(){
  const adv = await j('data/adventurer_jobs.json', []);
  const classes = adv.map(x=>({
    jobClass: (x['Job Class']||'').toString(),
    jobType : (x['Job Type']||'').toString(),
    final   : (x['Final Code']||'').toString(),
    rank    : (x['Job Rank']||'').toString(),
    advr    : (x['ADVR Code']||'').toString(),
    desc    : (x['Description']||'').toString(),
    reqLvl  : Number(x['Required Level']||0)
  })).filter(x=>x.jobClass && x.jobType);

  const types = [...new Set(classes.map(c=>c.jobType))].sort().map(t=>({label:t}));

  $('#typeTrigger').addEventListener('click', ()=>{
    Combo.open({
      titleText:'Select Job Type',
      data: types,
      onPick:(label)=>{ S.jobType=label; S.archetype=null; save(); $('#typeTrigger').value=label; $('#advTransitions').innerHTML=''; $('#advTransitions').style.display='none'; renderBaseGrid(); }
    });
  });

  const grid = $('#advGrid');
  function img(final){ const suffix=(String(S.gender).toLowerCase()==='male') ? '_m' : '_f'; return `assets/adventurers/${final}${suffix}.png`; }
  function baseForType(){ return classes.filter(c=>c.jobType===S.jobType && c.reqLvl===0); }

  function renderBaseGrid(){
    grid.innerHTML='';
    if(!S.jobType) return;
    baseForType().forEach(c=>{
      const card=document.createElement('button');
      card.className='card'; card.type='button';
      card.setAttribute('aria-pressed', S.archetype && S.archetype.final===c.final ? 'true':'false');
      card.innerHTML = `
        <img class="silhouette" src="${img(c.final)}" width="96" height="96" alt="${c.jobClass}" onerror="this.onerror=null;this.src='assets/adventurers/_placeholder.png'">
        <div><div style="font-weight:900;font-size:20px">${c.jobClass}</div><div class="tip">${c.desc}</div></div>`;
      card.onclick=()=>{ S.archetype=c; save(); grid.innerHTML=''; renderTransitions(c); };
      grid.appendChild(card);
    });
  }

  function findRank(group, needle){ return group.find(x => new RegExp(needle,'i').test(x.rank)); }
  function mini(rec){ if(!rec) return ''; return `
    <div class="mini-card card" tabindex="0">
      <span class="tooltip">${rec.desc||''}</span>
      <img class="silhouette" src="${img(rec.final)}" alt="${rec.jobClass}" onerror="this.onerror=null;this.src='assets/adventurers/_placeholder.png'">
      <div><div class="mini-title">${rec.jobClass}</div></div>
    </div>`; }
  function hero(rec){ return `
    <div class="hero-wrap">
      <div class="hero-card">
        <img class="hero-img" src="${img(rec.final)}" alt="${rec.jobClass}" onerror="this.onerror=null;this.src='assets/adventurers/_placeholder.png'">
        <div><div class="hero-name">${rec.jobClass}</div><div class="hero-desc">${rec.desc}</div></div>
      </div>
    </div>`; }
  function arrowDown(){ return `<div class="arrow-down" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 2 v16 M5 12 l7 7 7-7"/></svg></div>`; }

  function renderTransitions(base){
    const group = classes.filter(x=>x.advr===base.advr);
    const alt1 = findRank(group,'Alternate\\s*1');
    const alt2 = findRank(group,'Alternate\\s*2');
    const master1 = findRank(group,'Master\\s*1');
    const master2 = findRank(group,'Master\\s*2');

    const wrap = $('#advTransitions');
    wrap.innerHTML = `
      ${hero(base)}
      <div class="trans-cols">
        <div>${arrowDown()} ${mini(alt1)} ${arrowDown()} ${mini(master1)}</div>
        <div>${arrowDown()} ${mini(alt2)} ${arrowDown()} ${mini(master2)}</div>
      </div>`;
    wrap.style.display='block';
    $('#advExplore').style.display='';
  }

  renderBaseGrid();
  $('#advBack').onclick = ()=> goTo(5);

  const modal = $('#confirmModal'), loader=$('#loader');
  function openModal(){ modal.classList.add('show'); }
  function closeModal(){ modal.classList.remove('show'); }
  $('#advProceed').onclick = ()=>{ if(!S.archetype){ warn($('#advWarn'), true); return; } warn($('#advWarn'), false); openModal(); };
  $('#cancelProceed').onclick = ()=> closeModal();
  $('#confirmProceed').onclick = ()=>{ loader.style.display='block'; setTimeout(()=>{ loader.style.display='none'; closeModal(); buildFinal(); goTo('final'); },900); };
  $('#advExplore').onclick = ()=>{ $('#advTransitions').innerHTML=''; $('#advTransitions').style.display='none'; S.archetype=null; save(); renderBaseGrid(); };
})();

/* ---------- FINAL ---------- */
function buildFinal(){
  $('#finalName').textContent = S.displayName || (S.firstName ? S.firstName : 'Adventurer');
  const pro = `
    <div style="margin-bottom:6px"><strong>Name</strong></div>
    <div style="margin-bottom:12px">${S.firstName||''} ${S.lastName||''}</div>
    <div style="margin-bottom:6px"><strong>Display</strong></div>
    <div style="margin-bottom:12px">${S.displayName||'â€”'}</div>
    <div style="margin-bottom:6px"><strong>Gender</strong></div>
    <div style="margin-bottom:12px">${S.gender||'â€”'}</div>
    <div style="margin-bottom:6px"><strong>Country</strong></div>
    <div style="margin-bottom:12px">${S.country||'â€”'}</div>
    <div style="margin-bottom:6px"><strong>Jobs</strong></div>
    <div class="chips" style="margin-bottom:12px">${S.jobs.map(x=>`<span class="chip"><span>${x}</span></span>`).join(' ')||'â€”'}</div>
    <div style="margin-bottom:6px"><strong>Skills</strong></div>
    <div class="chips" style="margin-bottom:12px">${S.skills.map(x=>`<span class="chip"><span>${x}</span></span>`).join(' ')||'â€”'}</div>
    <div style="margin-bottom:6px"><strong>Interests</strong></div>
    <div class="chips">${S.interests.map(x=>`<span class="chip"><span>${x}</span></span>`).join(' ')||'â€”'}</div>`;
  $('#cardPro').innerHTML = pro;

  const suffix=(String(S.gender).toLowerCase()==='male') ? '_m' : '_f';
  const img = S.archetype ? `assets/adventurers/${S.archetype.final}${suffix}.png` : 'assets/adventurers/_placeholder.png';
  const adv = S.archetype ? `
    <div class="card" style="gap:16px">
      <img src="${img}" width="120" height="120" alt="${S.archetype.jobClass}" class="silhouette" onerror="this.onerror=null;this.src='assets/adventurers/_placeholder.png'">
      <div><div style="font-size:clamp(22px,3.4vw,34px);font-family:Cinzel,serif;font-weight:900">${S.archetype.jobClass}</div><div class="tip">${S.jobType}</div></div>
    </div>` : 'â€”';
  $('#cardAdv').innerHTML = adv;
}

/* ---------- Complete Profile ---------- */
document.addEventListener('click', e=>{
  if(e.target && e.target.id==='completeProfileBtn'){
    const saver = document.getElementById('saving');
    saver.classList.add('show');
    setTimeout(()=>{ window.location.href='profile.html'; },1400);
  }
});
</script>
</body>
</html>
