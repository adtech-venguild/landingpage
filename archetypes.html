<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>VENGUILD – Archetype Library</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --text:#ffffff;--muted:#e6edf4;--gold:#f6d694;--accent:#39e27e;--danger:#ff6b6b;
    --overlay:linear-gradient(180deg, rgba(8,12,16,.65), rgba(8,12,16,.78) 40%, rgba(8,12,16,.92));
    --glass:rgba(9,12,16,.55);--border:rgba(255,255,255,.18);
    --shadow:0 22px 60px rgba(0,0,0,.5);--glow:0 0 22px rgba(57,226,126,.45),0 0 7px rgba(57,226,126,.35);

    /* overlay + orb palette */
    --line:rgba(255,255,255,.14);
    --accent-2:#2cd18c;
    --aqua:#4da3ff; --terra:#7ef2b0; --zephyr:#e8eadf; --pyra:#ff6a6a; --aether:#b07a3a;
    --current: var(--aqua);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    color:var(--text);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--overlay), url('assets/background/background1.png') center / cover fixed no-repeat;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }
  .container{width:min(1180px,94vw); margin:0 auto; padding:28px 0 120px}

  header{display:grid; place-items:center; gap:8px; text-align:center}
  header img{width:88px; height:88px; object-fit:contain; filter:drop-shadow(0 0 14px rgba(0,0,0,.45))}
  h1{font-family:Cinzel,serif; font-weight:900; letter-spacing:.3px; font-size:clamp(28px,5.2vw,52px); margin:6px 0}
  .lead{color:var(--muted); max-width:820px; margin:0 auto}

  /* controls */
  .controls{margin:28px auto 18px; display:grid; gap:12px; place-items:center}
  .fake-select{
    width:min(560px,92vw); padding:14px; border-radius:12px; border:1px solid var(--border);
    background:var(--glass); color:#fff; outline:none; cursor:pointer; font-size:16px;
    backdrop-filter:blur(4px); transition:border-color .2s, box-shadow .2s;
  }
  .fake-select:focus{border-color:rgba(57,226,126,.65); box-shadow:0 0 0 3px rgba(57,226,126,.16)}

  .cta-row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:2px}
  .btn{background:linear-gradient(180deg,#38e07d,#1fb866); color:#06130d; font-weight:800; padding:12px 16px; border:none; border-radius:12px; cursor:pointer}
  .btn.secondary{background:rgba(255,255,255,.08); color:#fff; border:1px solid var(--border)}
  .btn.linkish{background:transparent; color:#fff; border:1px dashed var(--border)}

  /* grid */
  .section-title{font-family:Cinzel,serif; font-size:clamp(22px,3.2vw,30px); color:var(--gold); text-align:center; margin:24px 0 10px}
  .grid{display:grid; grid-template-columns:repeat(3,minmax(220px,1fr)); gap:16px}
  @media (max-width:860px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}

  .card{
    position:relative; display:flex; gap:14px; align-items:center;
    padding:14px; border-radius:16px; border:1px solid var(--border); background:var(--glass);
    backdrop-filter:blur(4px); color:#fff; cursor:pointer;
    transition:transform .12s ease, border-color .12s ease, box-shadow .12s ease;
  }
  .card:hover{transform:translateY(-2px); border-color:rgba(57,226,126,.55); box-shadow:var(--glow)}
  .thumb{width:96px; height:96px; border-radius:12px; object-fit:contain; background:rgba(255,255,255,.06); padding:6px}
  .card .name{font-weight:900; font-size:18px}
  .card .desc{font-size:13px; color:#deecfb}

  /* transitions */
  .transitions{margin-top:22px; display:none}
  .hero{
    display:flex; gap:16px; align-items:center;
    background:linear-gradient(180deg, rgba(10,18,24,.75), rgba(10,18,24,.92));
    border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow:0 18px 60px rgba(0,0,0,.55), var(--glow)
  }
  .hero img{width:140px; height:140px; border-radius:14px; object-fit:contain; background:rgba(255,255,255,.06); padding:8px}
  .hero .title{font-family:Cinzel,serif; font-size:clamp(22px,3.6vw,34px); font-weight:900}
  .hero .txt{color:#e9f7ff}
  .cols{display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px}
  @media (max-width:560px){.cols{grid-template-columns:1fr 1fr}}
  .mini{display:flex; gap:12px; align-items:center; border:1px solid var(--border); border-radius:12px; padding:10px; background:rgba(255,255,255,.03)}
  .mini img{width:84px; height:84px; border-radius:10px; object-fit:contain; background:rgba(255,255,255,.06); padding:6px}
  .arrow{height:30px; display:flex; align-items:center; justify-content:center; filter:drop-shadow(0 0 8px rgba(57,226,126,.4))}
  .arrow svg{width:34px; height:30px}
  .arrow path{stroke:#39e27e; stroke-width:6; fill:none; stroke-linecap:round; stroke-linejoin:round}

  /* ---------- ELEMENT OVERLAY (orb) ---------- */
  .elements-ov{position:fixed; inset:0; display:none; z-index:300}
  .elements-ov.show{display:block}
  .elements-bg{position:absolute; inset:0; background:rgba(0,0,0,.65); backdrop-filter:blur(3px)}
  .elements-card{
    position:absolute; inset:0; margin:auto; width:min(980px,94vw); max-height:92vh; overflow:auto;
    background:rgba(9,12,16,.94); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px;
  }
  .elements-card header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding-bottom:10px; border-bottom:1px solid var(--border)}
  .elements-title{font-family:Cinzel,serif; font-size:20px; margin:0}
  .elements-actions{display:flex; gap:8px}

  .pills{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; padding:12px 0 0}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    border:1px solid var(--line); background:rgba(255,255,255,.05);
    padding:10px 12px; border-radius:999px; font-weight:800; font-size:14px; color:#e9fffa; cursor:pointer;
    transition:transform .12s ease, border-color .12s ease, box-shadow .12s ease, background .12s ease;
  }
  .pill:hover{transform:translateY(-1px); border-color:rgba(57,226,126,.55); box-shadow:0 0 0 2px rgba(57,226,126,.22) inset}
  .pill.active{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#03130d; border-color:transparent; box-shadow:0 0 0 2px rgba(0,0,0,.25) inset}

  /* Orb Stage — compact and centered above text */
  .stage{display:grid; place-items:center; padding:12px 0 8px}
  .scene{position:relative; width:min(72vmin,560px); height:min(48vmin,360px); filter:drop-shadow(0 18px 36px rgba(0,0,0,.5))}
  .track{position:absolute; inset:0; display:grid; place-items:center}
  .orb-wrap{ position:relative; }

  /* -------------- ORB -------------- */
  /* NOTE: One compact orb, centered, placed above the lore text so it doesn't dominate the overlay. */
  .orb{
    --size:56px;
    position:relative; width:var(--size); height:var(--size); border-radius:50%; margin:auto;
    background:
      radial-gradient(circle at 32% 28%, #ffffff 0%, rgba(255,255,255,.65) 38%, rgba(0,0,0,.55) 100%),
      radial-gradient(circle at 70% 70%, color-mix(in srgb, var(--current) 70%, #0000), transparent 60%);
    box-shadow:
      0 0 12px var(--current),
      0 0 30px var(--current),
      0 0 90px color-mix(in srgb, var(--current) 70%, transparent);
    border:1px solid color-mix(in srgb, var(--current) 60%, #fff 40%);
    filter:saturate(1.12);
  }
  .orb::before{
    content:""; position:absolute; inset:-16px; border-radius:50%;
    background: radial-gradient(circle, color-mix(in srgb, var(--current) 25%, transparent), transparent 70%);
    filter: blur(10px); animation:pulse 3.2s ease-in-out infinite;
  }
  @keyframes pulse{ 0%,100%{opacity:.5; transform:scale(1)} 50%{opacity:1; transform:scale(1.08)} }

  .spark-field{ position:absolute; top:50%; left:50%; width:0; height:0; pointer-events:none; }
  .spark{
    --col:var(--current); --ang:0deg; --dist:26px; --ssize:4px; --dur:7s; --delay:0s;
    position:absolute; top:0; left:0; width:var(--ssize); height:var(--ssize); border-radius:50%;
    background: radial-gradient(circle at 40% 40%, #fff 0 40%, var(--col) 55%, transparent 75%);
    box-shadow: 0 0 6px var(--col), 0 0 16px color-mix(in srgb, var(--col) 85%, transparent);
    transform: translate(-50%,-50%) rotate(var(--ang)) translateX(var(--dist));
    animation: swirl var(--dur) linear infinite, twinkle calc(var(--dur) * .8) ease-in-out infinite;
    animation-delay: var(--delay);
  }
  @keyframes swirl{
    to{
      transform:
        translate(-50%,-50%)
        rotate(calc(var(--ang) + 360deg))
        translateX(var(--dist));
    }
  }
  @keyframes twinkle{ 0%,100%{ opacity:.2; filter:blur(.5px) } 15%{ opacity:.95; filter:blur(.2px) } 55%{ opacity:.35; filter:blur(.9px) } }

  .lore{max-width:840px; margin:10px auto 0; background:rgba(255,255,255,.05); border:1px solid var(--line); border-radius:14px; padding:12px}
  .lore h3{font-family:Cinzel,serif; font-size:20px; margin:0 0 6px; color:var(--gold)}
  .lore p{margin:0; color:#e9f7ff; line-height:1.6}

  /* ---- Combo dropdown item pointer ---- */
  .combo-item{padding:14px; cursor:pointer}
  .combo-item:hover{background:rgba(57,226,126,.10)}
</style>
</head>
<body>
  <div class="container">
    <header>
      <img src="assets/logo.png" alt="VENGUILD">
      <h1>Archetype Library</h1>
      <p class="lead">Pick a <strong>Job Type</strong> to browse Base classes. Click a card to view its path: <em>Base → Alternate → Master</em>.</p>
    </header>

    <div class="controls">
      <input id="typeTrigger" class="fake-select" type="text" placeholder="Tap to choose job type…" readonly>
      <div class="cta-row">
        <button id="learnBtn" class="btn">Learn about elements</button>
        <!-- Return to form is outside the overlay and redirects to unlock.html -->
        <a href="unlock.html" class="btn secondary">Return to form</a>
      </div>
    </div>

    <div class="section-title">Available Base Classes</div>
    <section id="grid" class="grid" aria-live="polite"></section>

    <section id="transitions" class="transitions">
      <div id="hero" class="hero">
        <img id="heroImg" alt="">
        <div>
          <div id="heroTitle" class="title">—</div>
          <div id="heroDesc" class="txt">—</div>
        </div>
      </div>

      <div class="cols">
        <div id="colL"></div>
        <div id="colR"></div>
      </div>
    </section>
  </div>

  <!-- Type dropdown overlay -->
  <div id="combo" class="combo" role="dialog" aria-modal="true" aria-labelledby="comboTitle" style="position:fixed; inset:0; display:none; place-items:center; z-index:120">
    <div class="combo-bg" style="position:absolute; inset:0; background:rgba(0,0,0,.65); backdrop-filter:blur(3px)"></div>
    <div class="combo-card" style="position:relative; width:min(560px,92vw); max-height:76vh; display:grid; grid-template-rows:auto 1fr auto; gap:12px; background:rgba(9,12,16,.95); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:14px">
      <div id="comboTitle" class="combo-title" style="font-weight:900; font-size:18px">Select Job Type</div>
      <input id="comboInput" class="combo-input" type="text" inputmode="search" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" placeholder="Type here to filter…" style="padding:14px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.06); color:#fff; outline:none; font-size:16px">
      <div id="comboList" class="combo-list" role="listbox" style="overflow:auto; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.04)"></div>
      <div class="combo-actions" style="display:flex; justify-content:flex-end; gap:8px"><button id="comboClose" class="btn secondary" type="button">Close</button></div>
    </div>
  </div>

  <!-- Elements overlay -->
  <div id="elementsOverlay" class="elements-ov" role="dialog" aria-modal="true" aria-labelledby="elTitle">
    <div class="elements-bg" data-close></div>
    <div class="elements-card">
      <header>
        <h2 id="elTitle" class="elements-title">Guild Elements Codex</h2>
        <div class="elements-actions">
          <button id="closeElements" class="btn secondary" type="button">Close</button>
        </div>
      </header>

      <!-- Pills -->
      <div id="pills" class="pills" aria-label="Element selector">
        <button class="pill active" data-el="Aqua">Aqua</button>
        <button class="pill" data-el="Terra">Terra</button>
        <button class="pill" data-el="Zephyr">Zephyr</button>
        <button class="pill" data-el="Pyra">Pyra</button>
        <button class="pill" data-el="Aether">Aether</button>
      </div>

      <!-- Orb above the text, compact & centered -->
      <section class="stage" aria-hidden="false">
        <div class="scene">
          <div class="track">
            <div class="orb-wrap">
              <!-- ORB (compact) -->
              <div class="orb" aria-label="Elemental orb"></div>
              <div id="sparks" class="spark-field" aria-hidden="true"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Lore -->
      <article id="lore" class="lore">
        <h3 id="loreTitle">Aqua — Field Notes</h3>
        <p id="loreText"></p>
      </article>
    </div>
  </div>

<script>
/* ------------- helpers & state ------------- */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> [...r.querySelectorAll(s)];
const S = { gender: (JSON.parse(localStorage.getItem('vg_signup_state')||'{}').gender || 'Female'), jobType:'', classes:[] };

/* ------------- element lore data ------------- */
const LORE = {
  Aqua: {
    title: "Aqua — Field Notes",
    text: `
<b>Etymology.</b> From the old tongue for “water”, keeper of flow and memory.<br><br>
<b>Nature.</b> Water obeys gravity and temperature—but in this world it also follows practiced intent.
Adept users redirect currents, borrow mist for cover, and braid streams through wounds to knit tissue.<br><br>
<b>Signature Powers.</b> Flow-step, pressure veil, ripple mending, tidecall.<br><br>
<b>Fusions.</b> With <i>Terra</i> → <u>Loam</u> (mudcraft, bulwarks). With <i>Zephyr</i> → <u>Storm</u> (mistwalk, lightning carry).
With <i>Pyra</i> → <u>Steam</u> (vents, enginework). With <i>Aether</i> → <u>Memory-Tide</u> (echo-reading).
The stronger parent colors the result—just like people.`
  },
  Terra: {
    title: "Terra — Field Notes",
    text: `
<b>Etymology.</b> “Terra” as in earth, ground, oath-stone.<br><br>
<b>Nature.</b> Stone keeps shape; soil takes shape. Practitioners learn leverage and patience, turning tiny forces into immovable outcomes.<br><br>
<b>Signature Powers.</b> Anchor step, fault-line sense, rampart rise, ironbind.<br><br>
<b>Fusions.</b> With <i>Aqua</i> → <u>Loam</u>. With <i>Zephyr</i> → <u>Dust</u> (blind, scour). With <i>Pyra</i> → <u>Glass</u> (harden/shape).
With <i>Aether</i> → <u>Geomancy</u> (sigils set in stone). Strength skews the mix to fortress or fluidity.`
  },
  Zephyr: {
    title: "Zephyr — Field Notes",
    text: `
<b>Etymology.</b> From the gentle west wind; in guild use, any knife-quick current of air.<br><br>
<b>Nature.</b> Air trades pressure for motion. Trained hands steal initiative, carry voices, and slip where bodies can’t.<br><br>
<b>Signature Powers.</b> Slipstream, featherfall, whisper cast, arrow wake.<br><br>
<b>Fusions.</b> With <i>Aqua</i> → <u>Storm</u>. With <i>Terra</i> → <u>Dust</u>. With <i>Pyra</i> → <u>Blaze-Wind</u> (fanfire).
With <i>Aether</i> → <u>Song</u> (binding words to wind). Dominant element decides if the storm cuts or carries.`
  },
  Pyra: {
    title: "Pyra — Field Notes",
    text: `
<b>Etymology.</b> From “pyre”—fire that changes what it touches.<br><br>
<b>Nature.</b> Heat is risk made visible. Pyra eats, leaps, and forges; the wise rider sets limits before the spark.<br><br>
<b>Signature Powers.</b> Ember step, brand-sigil, furnace heart, flarebreak.<br><br>
<b>Fusions.</b> With <i>Aqua</i> → <u>Steam</u>. With <i>Zephyr</i> → <u>Blaze-Wind</u>. With <i>Terra</i> → <u>Glass</u>.
With <i>Aether</i> → <u>Spellfire</u> (thought-true flame). The greater will defines whether it burns or builds.`
  },
  Aether: {
    title: "Aether — Field Notes",
    text: `
<b>Etymology.</b> The “upper air”; guild shorthand for meaning, pattern, and memory between things.<br><br>
<b>Nature.</b> Aether binds words to reality. It is the grammar of magic, the ledger that remembers promises and names.<br><br>
<b>Signature Powers.</b> Name-binding, recall weave, fate-ink, sigil stitching.<br><br>
<b>Fusions.</b> With anything, Aether makes the hybrid <u>coherent</u>: Memory-Tide, Geomancy, Song, Spellfire.
The stronger partner decides the body; Aether supplies the mind.`
  }
};

/* ------------- assets helpers ------------- */
function img(final){ const suf = (String(S.gender).toLowerCase()==='male') ? '_m' : '_f'; return `assets/adventurers/${final}${suf}.png`; }
async function j(path){ try{ const r = await fetch(path,{cache:'no-store'}); if(!r.ok) return []; return await r.json(); }catch{ return []; } }

/* ------------- type dropdown (combo) ------------- */
const Combo = (()=> {
  const root = $('#combo'), input=$('#comboInput'), list=$('#comboList'), title=$('#comboTitle');
  let data = [], onPick = ()=>{};
  function open({titleText, options, pick}) {
    title.textContent = titleText||'Choose';
    data = options||[]; onPick = pick||(()=>{});
    render('');
    root.style.display='grid'; input.value=''; input.focus({preventScroll:true});
  }
  function close(){ root.style.display='none'; }
  function render(q){
    list.innerHTML='';
    const norm = s=> (s||'').toLowerCase();
    (q? data.filter(o=>norm(o.label).includes(norm(q))) : data).forEach(o=>{
      const div = document.createElement('div');
      div.className='combo-item'; div.textContent=o.label; div.tabIndex=0; div.setAttribute('role','option');
      div.onclick=()=>{ onPick(o.label); close(); };
      div.onkeydown=e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onPick(o.label); close(); } };
      list.appendChild(div);
    });
  }
  input.addEventListener('input', ()=> render(input.value));
  $('#comboClose').addEventListener('click', close);
  root.addEventListener('click', e=>{ if(e.target.classList.contains('combo-bg')) close(); });
  document.addEventListener('keydown', e=>{ if(root.style.display==='grid' && e.key==='Escape') close(); });
  return { open };
})();

/* ------------- grid renderers ------------- */
function renderGrid(){
  const wrap = $('#grid'); wrap.innerHTML='';
  if(!S.jobType){ wrap.innerHTML = `<div class="card" style="grid-column:1/-1;justify-content:center">Pick a Job Type above.</div>`; return; }
  const base = S.classes.filter(c=>c.jobType===S.jobType && c.reqLvl===0);
  base.forEach(c=>{
    const el = document.createElement('article');
    el.className='card';
    el.innerHTML = `
      <img class="thumb" src="${img(c.final)}" alt="${c.jobClass}" onerror="this.onerror=null;this.src='assets/adventurers/_placeholder.png'">
      <div><div class="name">${c.jobClass}</div><div class="desc">${c.desc||''}</div></div>`;
    el.addEventListener('click', ()=> renderPath(c));
    wrap.appendChild(el);
  });
}

function partMini(rec){
  if(!rec) return '';
  return `
    <div class="mini">
      <img src="${img(rec.final)}" alt="${rec.jobClass}" onerror="this.onerror=null;this.src='assets/adventurers/_placeholder.png'">
      <div><div style="font-weight:900">${rec.jobClass}</div><div style="font-size:13px; color:#deecfb">${rec.desc||''}</div></div>
    </div>`;
}
function arrow(){ return `<div class="arrow" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 2 v16 M5 12 l7 7 7-7"/></svg></div>`; }

function renderPath(base){
  const group = S.classes.filter(x=>x.advr===base.advr);
  const alt1   = group.find(x=>/alternate\s*1/i.test(x.rank));
  const alt2   = group.find(x=>/alternate\s*2/i.test(x.rank));
  const master1= group.find(x=>/master\s*1/i.test(x.rank));
  const master2= group.find(x=>/master\s*2/i.test(x.rank));

  $('#heroImg').src = img(base.final);
  $('#heroImg').alt = base.jobClass;
  $('#heroImg').onerror = function(){ this.onerror=null; this.src='assets/adventurers/_placeholder.png'; };
  $('#heroTitle').textContent = base.jobClass;
  $('#heroDesc').textContent  = base.desc || '—';

  $('#colL').innerHTML = `${arrow()}${partMini(alt1)}${arrow()}${partMini(master1)}`;
  $('#colR').innerHTML = `${arrow()}${partMini(alt2)}${arrow()}${partMini(master2)}`;

  $('#transitions').style.display='block';
  document.getElementById('transitions').scrollIntoView({behavior:'smooth', block:'start'});
}

/* ------------- ELEMENT OVERLAY (orb) ------------- */
const elOverlay  = $('#elementsOverlay');
const closeElBtn = $('#closeElements');
const learnBtn   = $('#learnBtn');

function openElements(){ elOverlay.classList.add('show'); document.body.style.overflow='hidden'; seedSparks(); setActive('Aqua'); }
function closeElements(){ elOverlay.classList.remove('show'); document.body.style.overflow=''; }

learnBtn.addEventListener('click', openElements);
closeElBtn.addEventListener('click', closeElements);
elOverlay.addEventListener('click', e=>{ if(e.target && e.target.hasAttribute('data-close')) closeElements(); });

/* color + sparks + lore switching */
function setElementColor(el){
  const root = document.documentElement.style;
  const key = el.toLowerCase();
  const map = { aqua:'--aqua', terra:'--terra', zephyr:'--zephyr', pyra:'--pyra', aether:'--aether' };
  const cssVar = map[key] || '--aqua';
  const color = getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
  root.setProperty('--current', color);
}
function seedSparks(){
  const box = $('#sparks'); box.innerHTML='';
  const COUNT = 24;
  const rnd = (a,b)=> a + Math.random()*(b-a);
  for(let i=0;i<COUNT;i++){
    const s=document.createElement('i');
    s.className='spark';
    s.style.setProperty('--ang',  rnd(0,360).toFixed(2)+'deg');
    s.style.setProperty('--dist', rnd(22, 64).toFixed(1)+'px');
    s.style.setProperty('--ssize',rnd(2, 5).toFixed(1)+'px');
    s.style.setProperty('--dur',  rnd(5.2, 9.6).toFixed(2)+'s');
    s.style.setProperty('--delay',(-rnd(0, 8)).toFixed(2)+'s');
    box.appendChild(s);
  }
}
function setActive(name){
  $$('#pills .pill').forEach(p=> p.classList.toggle('active', p.dataset.el===name));
  setElementColor(name);
  const data = LORE[name] || LORE.Aqua;
  $('#loreTitle').innerHTML = data.title;
  $('#loreText').innerHTML  = data.text;
}
$('#pills').addEventListener('click', e=>{
  const btn = e.target.closest('.pill'); if(!btn) return;
  setActive(btn.dataset.el); seedSparks();
});

/* ------------- boot ------------- */
(async function boot(){
  const raw = await j('data/adventurer_jobs.json');
  S.classes = raw.map(x=>({
    jobClass: (x['Job Class']||'').toString(),
    jobType : (x['Job Type']||'').toString(),
    final   : (x['Final Code']||'').toString(),
    rank    : (x['Job Rank']||'').toString(),
    advr    : (x['ADVR Code']||'').toString(),
    desc    : (x['Description']||'').toString(),
    reqLvl  : Number(x['Required Level']||0)
  })).filter(x=>x.jobClass && x.jobType);

  const types = [...new Set(S.classes.map(c=>c.jobType))].sort().map(t=>({label:t}));

  // open dropdown
  $('#typeTrigger').addEventListener('click', ()=>{
    Combo.open({
      titleText:'Select Job Type',
      options: types,
      pick: (label)=>{ S.jobType = label; $('#typeTrigger').value = label; $('#transitions').style.display='none'; renderGrid(); }
    });
  });

  renderGrid();

  // deep link ?type=Magic
  const dlType = new URL(location.href).searchParams.get('type');
  if(dlType && types.find(t=>t.label.toLowerCase()===dlType.toLowerCase())) {
    S.jobType = types.find(t=>t.label.toLowerCase()===dlType.toLowerCase()).label;
    $('#typeTrigger').value = S.jobType;
    renderGrid();
  }

  // preload default lore text
  setActive('Aqua');
})();
</script>
</body>
</html>
