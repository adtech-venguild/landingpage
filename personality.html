<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VENGUILD – Adventurer Aptitude Exam</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0c1116; --card:#0f141a; --line:rgba(255,255,255,.12);
    --text:#e9ecf1; --muted:#a9b4c1; --gold:#ffdf9e; --accent:#37e07d;

    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-t: env(safe-area-inset-top, 0px);
    --safe-l: env(safe-area-inset-left, 0px);
    --safe-r: env(safe-area-inset-right, 0px);
  }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0}
  html, body{
    overflow-y:auto; overflow-x:hidden;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none; -ms-overflow-style:none;
  }
  body::-webkit-scrollbar{width:0;height:0}

  body{
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: var(--bg);
    color: var(--text);
    min-height: 100svh;
    padding: max(10px,14px);
    padding-left: calc(max(10px,14px) + var(--safe-l));
    padding-right: calc(max(10px,14px) + var(--safe-r));
    padding-top: max(10px,14px, var(--safe-t));
    display:grid; place-items:center;

    background-image: linear-gradient(to bottom, rgba(6,12,18,.55), rgba(6,12,18,.6)), url("assets/background/background1.png");
    background-size:cover; background-position:center;
  }

  .scene{ position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
  .stars{
    position:absolute; inset:-12%;
    background:
      radial-gradient(circle at 30% 20%, rgba(255,255,255,.25) 0 1px, transparent 2px) 0 0/180px 180px,
      radial-gradient(circle at 70% 60%, rgba(255,255,255,.18) 0 1px, transparent 2px) 0 0/220px 220px,
      radial-gradient(circle at 50% 50%, rgba(255,255,255,.10) 0 1px, transparent 2px) 0 0/260px 260px;
    opacity:.28; filter: blur(.2px);
    animation: star-drift 60s linear infinite;
  }
  @keyframes star-drift{ to{ transform: rotate(360deg) } }
  .swirl{
    position:absolute; left:50%; top:50%;
    width:max(120vmax,120vw); height:max(120vmax,120vh);
    transform:translate(-50%,-50%);
    filter: drop-shadow(0 10px 22px rgba(0,0,0,.45));
    opacity:.85;
  }
  .ring{ position:absolute; inset:0; border-radius:50%;
    background:conic-gradient(from 0deg, transparent 0 58%, rgba(60,170,160,.18) 63%, rgba(130,230,210,.20) 67%, transparent 73%);
    -webkit-mask:radial-gradient(circle, transparent 60%, black 63%, black 68%, transparent 71%);
            mask:radial-gradient(circle, transparent 60%, black 63%, black 68%, transparent 71%);
    animation: swirl-spin 40s linear infinite;
  }
  @keyframes swirl-spin{ to{ transform: rotate(360deg) } }
  .r1{ animation-duration:38s; transform:scale(.86) } .r2{ animation-duration:46s }
  .r3{ animation-duration:56s; transform:scale(1.18) } .r4{ animation-duration:70s; transform:scale(1.36) }
  .r5{ animation-duration:90s; transform:scale(1.58) }
  .texture{ position:absolute; inset:-18%; background:
      radial-gradient(circle at 50% 50%, rgba(30,140,130,.20), transparent 60%),
      repeating-radial-gradient(circle at 50% 60%, rgba(255,255,255,.035) 0 2px, transparent 2px 6px);
    mix-blend-mode: screen; opacity:.55; animation: slow-rotate 120s linear infinite }
  .core{ position:absolute; left:50%; top:50%; width:38vmin; height:38vmin; transform:translate(-50%,-50%);
    border-radius:50%; background: radial-gradient(circle at 50% 52%, rgba(140,255,230,.26) 0 55%, rgba(20,120,110,.12) 60%, transparent 70%);
    filter: blur(10px) saturate(1.05); opacity:.70; animation: core-pulse 7s ease-in-out infinite; }
  @keyframes slow-rotate{ to{ transform: rotate(360deg) } }
  @keyframes core-pulse{ 0%,100%{ transform:translate(-50%,-50%) scale(1) } 50%{ transform:translate(-50%,-50%) scale(1.06) } }

  .wrap{
    width:min(1200px,100%);
    display:grid; gap:22px;
    grid-template-columns: 1fr;
    position:relative; z-index:1;
    animation:fade .45s ease;
  }
  @keyframes fade{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}

  .pane{ position:relative; z-index:5; border-radius:24px; padding:0 0 calc(14px + var(--safe-b)) 0; }
  .pane::before{
    content:"";
    position:absolute; inset:-26px; border-radius:24px;
    background:
      radial-gradient(120% 80% at 80% 40%, rgba(111,227,255,.10), transparent 60%),
      radial-gradient(90% 70%  at 20% 70%, rgba(55,224,125,.10),  transparent 65%),
      rgba(10,16,23,.55);
    box-shadow:
      0 0 0 1px rgba(255,255,255,.08),
      0 20px 80px rgba(0,0,0,.55),
      inset 0 0 200px rgba(55,224,125,.10),
      inset 0 0 140px rgba(111,227,255,.08);
    backdrop-filter: blur(6px);
    pointer-events:none;
  }
  .inner{ position:relative; padding:12px 14px; }

  header h1{font-family:Cinzel,serif; font-size: clamp(24px,6vw,46px); margin:0; color:var(--gold)}
  .sub{color:#cfe3ff; margin:6px 0 0; letter-spacing:.04em}
  .chips{display:flex; flex-wrap:wrap; gap:10px; margin:14px 0 0}
  .chip{padding:8px 12px; border-radius:999px; border:1px solid #1b2738; background:#0b1015; font-weight:700; color:#cfe6ff; letter-spacing:.02em}
  .rank{width:44px; height:44px; display:grid; place-items:center; border-radius:10px; border:1px solid #5f80ae; background:#0b1015; color:#cfe6ff; font-weight:900}

  #questions{display:grid; gap:12px; margin-top:14px}
  .q{ border:1px solid var(--line); border-radius:14px; background:#0b1015; padding:12px; display:grid; gap:10px; }
  .q .t{font-weight:700; line-height:1.4}
  .q.miss{ outline:2px solid #ff7a7a; box-shadow:0 0 0 4px rgba(255,122,122,.15); animation:shake .25s ease }
  @keyframes shake{ 25%{transform:translateX(-2px)} 50%{transform:translateX(2px)} 75%{transform:translateX(-1px)} }

  /* Likert options */
  .scale{ display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; }
  .opt{
    display:flex; align-items:center; justify-content:flex-start; gap:10px;
    border:1px solid #1b2738; background:#0a1119; border-radius:10px;
    padding:12px 12px; cursor:pointer; user-select:none; text-align:left;
    line-height:1.2; transition:transform .15s ease, border-color .15s ease, background .15s ease;
    font-size: clamp(12px, 2.8vw, 14px); min-height:48px;
  }
  .opt:hover{ transform:translateY(-1px); border-color:#2a3a55 }
  .opt input{
    appearance:none; width:18px; height:18px;
    border:2px solid #5b7aa7; border-radius:50%;
    display:inline-block; position:relative; flex:0 0 auto;
  }
  .opt input:checked{
    border-color:transparent;
    background:
      radial-gradient(circle at 50% 50%, #3fe199 0 50%, transparent 52%),
      linear-gradient(135deg,#3fe199,#2ccf86);
  }

  /* Portrait 2×2 + Neutral centered */
  @media (max-width: 820px) and (orientation: portrait){
    .scale{
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "sa a"
        "n  n"
        "d  sd";
    }
    .opt--sa{ grid-area: sa; }
    .opt--a { grid-area: a; }
    .opt--n { grid-area: n; justify-content:center; }
    .opt--d { grid-area: d; }
    .opt--sd{ grid-area: sd; }
  }

  /* Footer + big submit button */
  .footer{display:flex; gap:12px; align-items:center; margin-top:14px}
  .bar{height:10px; background:#0a1119; border:1px solid #1b2738; border-radius:999px; overflow:hidden}
  .bar>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#37e07d,#86ffc6); box-shadow:0 0 12px rgba(55,224,125,.55)}
  .btn{
    appearance:none; border:none; cursor:pointer;
    background:linear-gradient(135deg,#37e07d,#1aa37c);
    color:#0c1116; font-weight:900; letter-spacing:.04em; text-transform:uppercase;
    border-radius:14px; padding:16px 22px; min-width:220px; font-size:16px;
    box-shadow:0 14px 24px rgba(0,0,0,.45), 0 0 18px rgba(55,224,125,.35), inset 0 0 8px rgba(255,255,255,.18);
    transition:transform .15s ease, filter .15s ease, opacity .15s ease;
  }
  .btn:hover{ transform:translateY(-1px) scale(1.02) }
  .btn:disabled{ opacity:.55; filter:grayscale(.2); cursor:not-allowed }

  @media (max-width:600px){
    .btn{ width:100%; font-size:18px; padding:18px 22px; }
  }

  /* Right-side clickable progress line */
  .sideProgress{
    position:fixed; right: max(6px, calc(4px + var(--safe-r)));
    top: calc(10px + var(--safe-t)); bottom: calc(10px + var(--safe-b));
    width:10px; border-radius:999px; background:rgba(255,255,255,.08);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);
    z-index:20; cursor:pointer;
  }
  .sideProgress > i{
    position:absolute; left:0; bottom:0; width:100%; height:0%;
    border-radius:999px;
    background:linear-gradient(180deg,#37e07d,#86ffc6);
    box-shadow:0 0 10px rgba(55,224,125,.6);
  }
</style>
</head>
<body>

  <!-- Swirling background -->
  <section class="scene" aria-hidden="true">
    <div class="stars"></div>
    <div class="swirl">
      <div class="ring r1"></div>
      <div class="ring r2"></div>
      <div class="ring r3"></div>
      <div class="ring r4"></div>
      <div class="ring r5"></div>
      <div class="texture"></div>
      <div class="core"></div>
    </div>
  </section>

  <!-- Clickable completion line -->
  <div class="sideProgress" id="sideBar" title="Jump to next unanswered / bottom"><i id="sideFill"></i></div>

  <div class="wrap">
    <section class="pane">
      <div class="inner">
        <header>
          <h1>Adventurer Aptitude Exam</h1>
          <p class="sub" id="hello">Welcome to your first quest!</p>
          <div class="chips" id="stats">
            <div class="chip" id="aff">Elemental Affinity: —</div>
            <div class="chip" id="titleChip">Title: —</div>
            <div class="chip">Total Level: <span id="lvl" style="margin-left:6px;font-weight:900">—</span></div>
            <div class="chip">Rank: <span id="rankChip">—</span></div>
          </div>
          <p class="muted" style="margin-top:8px">Answer honestly. Neutral (X) counts as no preference.</p>
        </header>

        <div id="questions"></div>

        <div class="footer">
          <div style="flex:1">
            <div class="bar"><i id="pbar"></i></div>
            <div class="muted" id="ptext" style="margin-top:6px">0/0 answered</div>
          </div>
          <button class="btn" id="submitBtn" disabled>Finish & Reveal</button>
        </div>
      </div>
    </section>
  </div>

<script>
/* ---------- paths ---------- */
const PATH_EXAM     = 'data/personalitytest.json';
const PATH_SECTORS  = 'data/sectors.json';
const PATH_PROGRAMS = 'data/programs.json';
const PATH_ELEMENTS = 'data/elements.json';
const PATH_JOBS     = 'data/adventurer_jobs.json';

/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const safe = x => (x==null ? '' : String(x));
const dedup = a => [...new Set(a)];
const sortDigits = s => s.split('').sort().join('');
async function getJSON(path){ const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw new Error(path+' → '+r.status); return r.json(); }

/* ---------- level → title/rank ---------- */
function levelTitle(total){ if(total>=100) return 'Master'; if(total>=76) return 'Advanced II'; if(total>=51) return 'Advanced I'; if(total>=26) return 'Apprentice'; return 'Aspirant'; }
function baseRankFor(level){ return level==='Master'?'B':level==='Advanced II'?'C':level==='Advanced I'?'D':level==='Apprentice'?'E':'F'; }
function countVerifications(){ try{ const v=JSON.parse(localStorage.getItem('venguild_verifications')||'{}')||{}; return ['twoIDs','employment','diploma','tor','address','payslip','billing','ecommerce'].reduce((n,k)=>n+(v[k]?1:0),0);}catch{return 0;} }
function finalRankFor(level){ const L=['F','E','D','C','B','A','S']; const b=L.indexOf(baseRankFor(level)); const steps=Math.min(countVerifications(), L.length-1-b); return L[b+steps]; }

/* ---------- header stats ---------- */
(async function loadHeader(){
  const raw = localStorage.getItem('venguild_complete_profile');
  if (!raw) return;
  const profile = JSON.parse(raw);

  const first = safe(profile?.name?.first||'Adventurer');
  const last  = safe(profile?.name?.last||'');
  $('#hello').textContent = `Welcome to your first quest, ${[first,last].filter(Boolean).join(' ')}!`;

  const expTotal = (profile.experience||[]).reduce((s,x)=> s + Number(x.computedLevel || (x.years||0)*(x.multiplier||0)), 0);
  const eduTotal = (profile.education||[]).reduce((s,x)=> s + Number(x.multiplier||0), 0);
  const total    = expTotal + eduTotal;
  const title    = levelTitle(total);
  const rank     = finalRankFor(title);

  $('#lvl').textContent = isFinite(total) ? total : '—';
  $('#titleChip').textContent = `Title: ${title}`;
  $('#rankChip').textContent  = rank || '—';

  try{
    const [sectors, programs, elements] = await Promise.all([getJSON(PATH_SECTORS), getJSON(PATH_PROGRAMS), getJSON(PATH_ELEMENTS)]);
    const sectorCodeToElem = new Map((sectors||[]).map(s=>[ String(s.Code||s.code||'').trim(), Number(s.ElementCode||s.elementCode||0) ]));
    const progToElem = (programs||[]).reduce((m,p)=>{ m[String(p.Program||p.title||'').trim().toLowerCase()] = Number(p.ElementCode||p.elementCode||0); return m; },{});
    const expElems = (profile.experience||[]).map(x=> sectorCodeToElem.get(String(x.code||'').trim()) || 0);
    const eduElems = (profile.education||[]).map(e=> progToElem[String(e.program||'').trim().toLowerCase()] || 0);
    const comboKey = sortDigits(dedup([...expElems, ...eduElems].filter(Boolean).map(String)).join(''));
    let affinityName = '—';
    if (comboKey){
      const hit = elements.find(it => sortDigits(String(it.Code||it.code||''))===comboKey);
      affinityName = hit ? (hit.Combination||hit.name||hit.title||'—') : '—';
    }
    $('#aff').textContent = `Elemental Affinity: ${affinityName}`;
  }catch{ $('#aff').textContent = `Elemental Affinity: —`; }
})();

/* ---------- build the exam ---------- */
const OPTIONS = [
  {key:'sa', label:'Strongly Agree',     area:'sa'},
  {key:'a',  label:'Agree',              area:'a'},
  {key:'n',  label:'Neutral (X)',        area:'n'},
  {key:'d',  label:'Disagree',           area:'d'},
  {key:'sd', label:'Strongly Disagree',  area:'sd'}
];
let QUESTIONS = [];

function buildQuestions(list){
  QUESTIONS = list || [];
  const grid = $('#questions'); grid.innerHTML='';
  QUESTIONS.forEach((q,i)=>{
    const card = document.createElement('div'); card.className='q'; card.id=`card${i}`;
    card.setAttribute('data-index', i);
    card.innerHTML = `<div class="t">${q.text||'(missing text)'}</div>`;
    const scale = document.createElement('div'); scale.className='scale';

    OPTIONS.forEach(opt=>{
      const id = `q${i}_${opt.key}`;
      const lab = document.createElement('label');
      lab.className = `opt opt--${opt.key}`;
      lab.setAttribute('for', id);

      const input = document.createElement('input');
      input.type='radio'; input.name=`q${i}`; input.id=id; input.value=opt.key;

      lab.appendChild(input);
      lab.appendChild(document.createTextNode(opt.label));
      scale.appendChild(lab);
    });

    card.appendChild(scale);
    grid.appendChild(card);
  });
  updateProgress();
}

function countAnswered(){
  return QUESTIONS.reduce((n,_,i)=> n + (document.querySelector(`input[name="q${i}"]:checked`)?1:0), 0);
}

function updateProgress(){
  const total = QUESTIONS.length;
  const answered = countAnswered();
  const pct = total ? Math.round(100*answered/total) : 0;
  $('#pbar').style.width = pct + '%';
  $('#sideFill').style.height = pct + '%';
  $('#ptext').textContent = `${answered}/${total} answered`;
  $('#submitBtn').disabled = answered < total;
}
document.addEventListener('change', e=>{
  if (e.target.matches('input[type="radio"]')) {
    const card = e.target.closest('.q'); card && card.classList.remove('miss');
    updateProgress();
  }
});

function firstUnansweredIndex(){
  for (let i=0;i<QUESTIONS.length;i++){
    if (!document.querySelector(`input[name="q${i}"]:checked`)) return i;
  }
  return -1;
}
function scrollToQuestion(idx){
  const card = document.getElementById(`card${idx}`);
  if (!card) return;
  card.classList.add('miss');
  card.scrollIntoView({behavior:'smooth', block:'center'});
  setTimeout(()=> card.classList.remove('miss'), 900);
}

/* Clickable green side bar behavior */
$('#sideBar').addEventListener('click', ()=>{
  const idx = firstUnansweredIndex();
  if (idx !== -1){
    scrollToQuestion(idx);
  } else {
    // all answered → jump to bottom (near the button)
    document.getElementById('submitBtn').scrollIntoView({behavior:'smooth', block:'center'});
  }
});

/* ---------- load test ---------- */
(async function boot(){
  const data = await getJSON(PATH_EXAM);
  if (!data || !Array.isArray(data.questions)) throw new Error('personalitytest.json is missing a "questions" array.');
  buildQuestions(data.questions);
})();

/* ---------- helpers for scoring & raw saving ---------- */
const SCORE = { SA:2, A:1, N:0, D:-1, SD:-2 };
const AXES   = { AD:['A','D'], VE:['V','E'], NT:['N','T'], UR:['U','R'], ER:['E','R'] };

function computeFromAnswers(answers){
  const breakdown = { AD:{A:0,D:0,NT:0,score:0}, VE:{V:0,E:0,NT:0,score:0}, NT:{N:0,T:0,NT:0,score:0}, UR:{U:0,R:0,NT:0,score:0}, ER:{E:0,R:0,NT:0,score:0} };

  (answers||[]).forEach(a=>{
    const axis=(a.axis||'').toUpperCase(); if(!AXES[axis]) return;
    const orient=(a.orient||'L').toUpperCase();
    const raw=(a.answer||'N').toUpperCase();
    const val=SCORE[raw]==null?0:SCORE[raw];
    const sign = orient==='R' ? -1 : 1;
    const eff = val*sign;
    breakdown[axis].score += eff;
    if (val===0){ breakdown[axis].NT++; return; }
    const [L,R]=AXES[axis];
    if (eff>0) breakdown[axis][L]++; else breakdown[axis][R]++;
  });

  const winners={};
  for(const k of Object.keys(AXES)){
    const [L,R]=AXES[k];
    const s=breakdown[k].score;
    if(k==='NT' && s===0) winners[k]=L; else winners[k]= s>=0?L:R;
  }
  return {breakdown, winners, advrCode: winners.AD+winners.VE+winners.NT+winners.UR, ER:winners.ER};
}

/* ---------- scoring + mapping (same logic) ---------- */
function pick(dim,a,b){ return (dim[a]===dim[b]) ? a : (dim[a] > dim[b] ? a : b); }

document.getElementById('submitBtn').addEventListener('click', async ()=>{
  // If incomplete, jump to next unanswered
  const missingIdx = firstUnansweredIndex();
  if (missingIdx !== -1){ scrollToQuestion(missingIdx); return; }

  /* ---- Build raw answers for resolver page ---- */
  const rawAnswers = QUESTIONS.map((q,i)=>{
    const val = (document.querySelector(`input[name="q${i}"]:checked`)||{}).value || 'n';
    const ans = val.toUpperCase(); // SA/A/N/D/SD
    const pair = (q.pair||'AD').toUpperCase(); const L = pair[0], R = pair[1];
    // determine which side "Agree" favors by comparing d1/d2 to pair order
    let orient='L';
    const d1 = (q.d1||'').toUpperCase(); const d2=(q.d2||'').toUpperCase();
    if (d1===R && d2===L) orient='R'; else if (d1===L && d2===R) orient='L';
    return { axis: pair, orient, answer: ans.toUpperCase() };
  });
  localStorage.setItem('venguild_personality_answers', JSON.stringify(rawAnswers));

  /* ---- Tally for immediate result + job mapping ---- */
  const dims = { AD:{A:0,D:0}, VE:{V:0,E:0}, NT:{N:0,T:0}, UR:{U:0,R:0} };
  const totals   = { AD:0, VE:0, NT:0, UR:0 };
  const neutrals = { AD:0, VE:0, NT:0, UR:0 };
  let Ecount=0, Rcount=0;

  QUESTIONS.forEach((q,i)=>{
    const val = (document.querySelector(`input[name="q${i}"]:checked`)||{}).value;
    const pair = q.pair; if (!pair) return;
    totals[pair] += 1;
    const agreeER = q.exaltedForAgree || q.er1 || q.exAgree || q.erAgree || null;
    const disagreeER = q.rootedForDisagree || q.er2 || q.exDisagree || q.erDisagree || null;

    const pos = (val==='sa'||val==='a');
    const neg = (val==='d'||val==='sd');
    const neu = (val==='n');

    if (neu) { neutrals[pair] += 1; return; }

    if (pos) {
      if (q.d1) dims[pair][q.d1] += 1;
      if (agreeER==='E') Ecount++;
      if (agreeER==='R') Rcount++;
    }
    if (neg) {
      if (q.d2) dims[pair][q.d2] += 1;
      if (disagreeER==='E') Ecount++;
      if (disagreeER==='R') Rcount++;
    }
  });

  const base = {
    AD: neutrals.AD === totals.AD ? 'X' : pick(dims.AD,'A','D'),
    VE: neutrals.VE === totals.VE ? 'X' : pick(dims.VE,'V','E'),
    NT: neutrals.NT === totals.NT ? 'X' : pick(dims.NT,'N','T'),
    UR: neutrals.UR === totals.UR ? 'X' : pick(dims.UR,'U','R'),
  };

  const res = {...base};
  if (res.AD==='X' && res.VE!=='X'){ res.AD = (res.VE==='V' ? 'A' : 'D'); }
  if (res.NT==='X' && res.UR!=='X'){ res.NT = (res.UR==='U' ? 'N' : 'T'); }
  if (res.UR==='X' && res.NT!=='X'){ res.UR = (res.NT==='N' ? 'U' : 'R'); }

  const neutralDims = Object.values(res).filter(v=>v==='X').length;
  const ERraw = (Ecount===Rcount) ? '' : (Ecount>Rcount ? 'E' : 'R');

  /* Save the computed raw breakdown too (so Resolver shows immediately) */
  const calc = computeFromAnswers(rawAnswers);
  try{
    const current = JSON.parse(localStorage.getItem('venguild_personality')||'{}');
    localStorage.setItem('venguild_personality', JSON.stringify({
      ...current,
      advrCode: (current.advrCode || (res.AD+res.VE+res.NT+res.UR) || calc.advrCode || '').toUpperCase(),
      exaltedRooted: (current.exaltedRooted || ERraw || calc.ER || 'n/a'),
      personality: (current.personality || (res.AD+res.VE+res.NT+res.UR) || calc.advrCode || '').toUpperCase(),
      breakdown: {
        AD:{A:calc.breakdown.AD.A||0,D:calc.breakdown.AD.D||0,NT:calc.breakdown.AD.NT||0},
        VE:{V:calc.breakdown.VE.V||0,E:calc.breakdown.VE.E||0,NT:calc.breakdown.VE.NT||0},
        NT:{N:calc.breakdown.NT.N||0,T:calc.breakdown.NT.T||0,NT:calc.breakdown.NT.NT||0},
        UR:{U:calc.breakdown.UR.U||0,R:calc.breakdown.UR.R||0,NT:calc.breakdown.UR.NT||0},
        ER:{E:calc.breakdown.ER.E||0,R:calc.breakdown.ER.R||0,NT:calc.breakdown.ER.NT||0}
      }
    }));
  }catch{}

  const profile = JSON.parse(localStorage.getItem('venguild_complete_profile')||'{}');
  const expTotal = (profile.experience||[]).reduce((s,x)=> s + Number(x.computedLevel || (x.years||0)*(x.multiplier||0)), 0);
  const eduTotal = (profile.education||[]).reduce((s,x)=> s + Number(x.multiplier||0), 0);
  const totalLevel = expTotal + eduTotal;
  const title = levelTitle(totalLevel);
  const rank  = finalRankFor(title);

  if (neutralDims >= 2){
    localStorage.setItem('venguild_personality', JSON.stringify({
      monster: true,
      avatar: "assets/default/creep.png",
      note: "Too many Neutrals (X). Self-awareness requires choices—try again with fewer X’s!",
      level: totalLevel, title, rank, ER: ERraw || 'n/a'
    }));
    window.location.href = 'unlock.html';
    return;
  }

  const code4 = res.AD + res.VE + res.NT + res.UR;
  const code  = (totalLevel >= 51 && ERraw) ? `${code4}-${ERraw}` : code4;

  function levelBucket(total){ if (total > 100) return 100; if (total > 50) return 50; return 0; }
  function rankPreferenceForBucket(bucket){
    if (bucket === 100) return ['Master 2','Master 1','Master'];
    if (bucket === 50)  return ['Alternate 2','Alternate 1','Alternate'];
    return ['Base Class'];
  }
  function norm(s){ return String(s ?? '').trim(); }
  function pickJobFromCatalog(catalog, bucket, advrCode4, ER){
    const targetADVR = norm(advrCode4).toUpperCase();
    const targetER   = bucket === 0 ? 'N/A' : norm(ER).toUpperCase();
    const pool = (catalog||[]).filter(row => {
      const RL  = Number(row['Required Level'] ?? row.RequiredLevel ?? 0);
      const AC  = norm(row['ADVR Code']).toUpperCase();
      const ERv = (norm(row['Exalted/Rooted']).toUpperCase() || 'N/A');
      if (RL !== bucket) return false;
      if (AC !== targetADVR) return false;
      if (bucket === 0){ return (ERv === 'N/A' || ERv === '' || ERv === 'NA'); }
      return ERv === targetER;
    });
    if (!pool.length) return null;
    const pref = rankPreferenceForBucket(bucket).map(x => x.toLowerCase());
    pool.sort((a,b)=>{
      const ra = norm(a['Job Rank']).toLowerCase();
      const rb = norm(b['Job Rank']).toLowerCase();
      const sa = Math.max(...pref.map((p,i)=> ra.includes(p) ? (100-i) : -1));
      const sb = Math.max(...pref.map((p,i)=> rb.includes(p) ? (100-i) : -1));
      return sb - sa;
    });
    return pool[0];
  }

  const bucket = levelBucket(totalLevel);
  const ER = bucket === 0 ? '' : ERraw;

  let job = null;
  try{
    const jobs = await getJSON(PATH_JOBS);
    job = pickJobFromCatalog(jobs, bucket, code4, ER);
  }catch(e){ console.warn('Job mapping failed:', e); }

  localStorage.setItem('venguild_personality', JSON.stringify({
    advrCode      : code4,
    exaltedRooted : ER || 'n/a',
    requiredLevel : bucket,
    level         : totalLevel,
    title         : title,
    rank          : rank,
    job           : job ? {
      jobClass    : job['Job Class'] || null,
      jobType     : job['Job Type']  || null,
      epiteth     : job['Epiteth']   || null,
      description : job['Description'] || null
    } : null,
    _backend      : job ? { finalCode: job['Final Code'] || null } : {},
    breakdown     : JSON.parse(localStorage.getItem('venguild_personality')||'{}').breakdown || null
  }));

  window.location.href = 'unlock.html';
});

/* keep stable svh on iOS when bars collapse/rotate */
window.addEventListener('orientationchange', ()=> document.body.style.minHeight = '100svh');
window.addEventListener('resize', ()=> document.body.style.minHeight = '100svh');
</script>
</body>
</html>
